<!doctype html><html lang=zh-cn><head><title>由 Reactor Netty HttpClient 的 response-timeout 设置错误引发的生产事故的反思 · 墨客人生</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Mervyn"><meta name=description content="在 onCall 的过程中，发生了一起由 Reactor Netty HttpClient 的 response-timeout 设置错误引发的 P2 级生产事故。造成了系统 1.5 小时部分功能不可用，使客户遭受了经济上的损失。本文期望针对完整的事件进行复盘与反思，以加强自己对线上环境的敬畏。"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="由 Reactor Netty HttpClient 的 response-timeout 设置错误引发的生产事故的反思"><meta name=twitter:description content="在 onCall 的过程中，发生了一起由 Reactor Netty HttpClient 的 response-timeout 设置错误引发的 P2 级生产事故。造成了系统 1.5 小时部分功能不可用，使客户遭受了经济上的损失。本文期望针对完整的事件进行复盘与反思，以加强自己对线上环境的敬畏。"><meta property="og:url" content="http://example.org/posts/rethink-of-production-incident-caused-by-the-wrong-configuration-of-respond-timeout-in-terms-of-reactor-netty-httpclient/"><meta property="og:site_name" content="墨客人生"><meta property="og:title" content="由 Reactor Netty HttpClient 的 response-timeout 设置错误引发的生产事故的反思"><meta property="og:description" content="在 onCall 的过程中，发生了一起由 Reactor Netty HttpClient 的 response-timeout 设置错误引发的 P2 级生产事故。造成了系统 1.5 小时部分功能不可用，使客户遭受了经济上的损失。本文期望针对完整的事件进行复盘与反思，以加强自己对线上环境的敬畏。"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-17T05:07:38+08:00"><meta property="article:modified_time" content="2024-01-17T05:07:38+08:00"><link rel=canonical href=http://example.org/posts/rethink-of-production-incident-caused-by-the-wrong-configuration-of-respond-timeout-in-terms-of-reactor-netty-httpclient/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.60f552a2c0452fcc0254c54f21c3e0728460c1ae85f97a9c35833a222ef8b884.css integrity="sha256-YPVSosBFL8wCVMVPIcPgcoRgwa6F+XqcNYM6Ii74uIQ=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/img/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/img/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=http://example.org/>墨客人生
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/life/>生活</a></li><li class=navigation-item><a class=navigation-link href=/posts/>博客</a></li><li class=navigation-item><a class=navigation-link href=/about-me>关于我</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=http://example.org/posts/rethink-of-production-incident-caused-by-the-wrong-configuration-of-respond-timeout-in-terms-of-reactor-netty-httpclient/>由 Reactor Netty HttpClient 的 response-timeout 设置错误引发的生产事故的反思</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2024-01-17T05:07:38+08:00>January 17, 2024
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
阅读时间：3 分钟
</span><span class=post-word-count>| 🍉 1012 字</span></div><div class=authors><i class="fa-solid fa-user" aria-hidden=true></i>
<a href=/authors/mervyn/>Mervyn</a></div></div></header><div class=post-content><p>在 onCall 的过程中，发生了一起由 Reactor Netty HttpClient 的 response-timeout 设置错误引发的 P2 级生产事故。造成了系统 1.5 小时部分功能不可用，使客户遭受了经济上的损失。本文期望针对完整的事件进行复盘与反思，以加强自己对线上环境的敬畏。</p><h2 id=问题表现>问题表现
<a class=heading-link href=#%e9%97%ae%e9%a2%98%e8%a1%a8%e7%8e%b0><i class="fa-solid fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><p>在 onCall 时，通过监控平台发现 Api-gateway 的 response time 和 failed request 数量持续不断攀升。从发现问题到解决，Response time 超过 500ms 持续 1小时40分钟，峰值为 3.14s；Failed request 峰值达到 4.14 k。
从用户侧来看系统部分功能卡顿或不可用，使用户在1.5小时内无法正常开展业务。</p><h2 id=采取的紧急措施>采取的紧急措施
<a class=heading-link href=#%e9%87%87%e5%8f%96%e7%9a%84%e7%b4%a7%e6%80%a5%e6%8e%aa%e6%96%bd><i class="fa-solid fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><p>通过排查发现前一天晚上，该 Api-gateway 有 changes，设置了全局的 HttpClient 和 Per-route 的 response-timeout。 其中全局的 HttpClient 的 response-timeout 为 x 秒。但是实际上系统存在一些 response time 超过 x 秒的请求，示例代码如代码清单 1-1 所示；Per-route 的 response-timeout 设置为 y 秒，但该 Per-route 的目标服务，也存在一些 response time 超过 y 秒的请求，示例代码如代码清单 1-2 所示。</p><p>代码清单 1-1 Gateway 全局的 HttpClient 的 response-timeout示例 application.yaml</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>spring</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>cloud</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>gateway</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>httpclient</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>connect-timeout</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>1000</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>response-timeout</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>5s</span><span style=color:#6e7681>
</span></span></span></code></pre></div><p>代码清单 1-2 Gateway Pre-route HttpClient 的 response-timeout 示例 application.yaml</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#7ee787>id</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>per_route_timeouts</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>uri</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>https://example.org</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>predicates</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>- <span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Path</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>args</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>pattern</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>/delay/{timeout}</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>response-timeout</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>200</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>connect-timeout</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>200</span><span style=color:#6e7681>
</span></span></span></code></pre></div><p>初步定位问题之后，立刻采取了回滚操作。通过回滚操作解决了问题，Api-Gateway 的 response time 和 failed request 逐渐回归正常。</p><h2 id=现象详细分析>现象详细分析
<a class=heading-link href=#%e7%8e%b0%e8%b1%a1%e8%af%a6%e7%bb%86%e5%88%86%e6%9e%90><i class="fa-solid fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><h2 id=根因分析>根因分析
<a class=heading-link href=#%e6%a0%b9%e5%9b%a0%e5%88%86%e6%9e%90><i class="fa-solid fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><ol><li>开发人员可能对 Reactor Netty HttpClient 的 response-timeout 参数含义不太清楚，将其与 nginx 的相关 timeout 参数搞混淆。</li><li>未评估修改该参数可能造成的影响和测试时没有 cover 该场景。</li></ol><p>首先明确 Reactor Netty HttpClient 的 response-timeout 的含义：</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>This is time that takes to receive a response after sending a request
</span></span></code></pre></div><p><img src=/rethink-of-production-incident-caused-by-the-wrong-configuration-of-respond-timeout-in-terms-of-Reactor-Netty-HttpClient/response-timeout.svg alt=response-time>
图 1-1 Reactor Netty HttpClient 的 response-timeout 含义</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>response-timeout = 请求传网络传输时间 + 请求处理时间 + 响应网络传输时间
</span></span></code></pre></div><blockquote></blockquote><p><a href=https://projectreactor.io/docs/netty/snapshot/reference/index.html#response-timeout class=external-link target=_blank rel=noopener>根据官方文档，Response-timeout 没有指定默认值。</a></p><p>结论：<strong>在设置了 Reactor Netty HttpClient 的 response-timeout 的情况下，如果服务消费方发现服务提供方超过了设定的 response-timeout，就会不等待服务提供方的响应，认为没有收到响应（响应失败）。</strong></p><h3 id=验证猜测>验证猜测
<a class=heading-link href=#%e9%aa%8c%e8%af%81%e7%8c%9c%e6%b5%8b><i class="fa-solid fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h3><p><img src=/rethink-of-production-incident-caused-by-the-wrong-configuration-of-respond-timeout-in-terms-of-Reactor-Netty-HttpClient/test-response-timeout.svg alt="测试 HttpClient 的 response-timeout"></p><p>图1-2 测试HttpClient 的 response-timeout</p><p>我们通过两个 HttpClient 的 response timeout 的测试，验证了我们的结论。
<a href=https://github.com/csmervyn/httpclient-test class=external-link target=_blank rel=noopener>实验的demo 源码</a></p><h2 id=产生的影响>产生的影响
<a class=heading-link href=#%e4%ba%a7%e7%94%9f%e7%9a%84%e5%bd%b1%e5%93%8d><i class="fa-solid fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><ul><li>客户侧：P2 incident 影响了业务的正常开展，产生了潜在的经济损失。</li><li>团队侧：影响团队的声誉和自信心，损害了团队与客户的关系。</li></ul><h2 id=action>Action
<a class=heading-link href=#action><i class="fa-solid fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><ol><li>排查 Reactor Netty HttpClient 潜在 response-timeout 配置错误的地方。</li><li>开发人员需要对 changes 所涉及内容完全掌握，对其产生的影响做到心中有数。需要坚守 &ldquo;no contexts, no code changes&rdquo; 的原则。</li><li>onCall 人员需要熟悉前一个晚上 changes 的内容。</li><li>控制上线节奏，质量优先。</li></ol><h2 id=reference>Reference
<a class=heading-link href=#reference><i class="fa-solid fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><ul><li><a href=https://stackoverflow.com/questions/64179173/netty-httpclient-response-timeout-vs-read-timeout class=external-link target=_blank rel=noopener>Netty HttpClient - response timeout vs. read timeout</a></li><li><a href=https://cloud.spring.io/spring-cloud-gateway/reference/html/appendix.html class=external-link target=_blank rel=noopener>spring.cloud.gateway.httpclient.response-timeout in Common application properties</a></li><li><a href=https://projectreactor.io/docs/netty/snapshot/reference/index.html#response-timeout class=external-link target=_blank rel=noopener>response-timeout of Reactor Netty HttpClient document</a></li></ul></div><div style="text-align:center;color:#a9a9a9;width:50%;margin:0 auto"><p>本作品采用<a href=http://creativecommons.org/licenses/by-nc-nd/4.0/ style=color:#a9a9a9>知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可</p></div><div style="border-bottom-style:dashed;border-bottom-style:inset;border-bottom-width:2px;width:50%;margin:0 auto"></div><footer><div class=comments><script>let getTheme=window.localStorage&&window.localStorage.getItem("colorscheme");getTheme=getTheme??"light";let s=document.createElement("script");s.src="https://giscus.app/client.js",s.setAttribute("data-repo","csmervyn/csmervyn.github.io"),s.setAttribute("data-repo-id","R_kgDOGbYn4A"),s.setAttribute("data-category","Announcements"),s.setAttribute("data-category-id","DIC_kwDOGbYn4M4CWQYR"),s.setAttribute("data-mapping","pathname"),s.setAttribute("data-term",""),s.setAttribute("data-strict","0"),s.setAttribute("data-reactions-enabled","1"),s.setAttribute("data-emit-metadata","0"),s.setAttribute("data-input-position","bottom"),s.setAttribute("data-theme",getTheme),s.setAttribute("data-lang","zh-CN"),s.setAttribute("data-loading",""),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.comments").innerHTML="",document.querySelector("div.comments").appendChild(s)</script></div></footer></article></section></div><footer class=footer><section class=container>©
2019 -
2025
Mervyn
·
技术支持 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>