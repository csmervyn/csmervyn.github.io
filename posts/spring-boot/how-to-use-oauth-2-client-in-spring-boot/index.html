<!doctype html><html lang=zh-cn><head><title>在 Spring Boot 中如何使用 OAuth 2.0 Client · 墨客人生
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Mervyn"><meta name=description content="
  背景
  
    
    链接到标题
  

目前有两个微服务 A 和 B，微服务 A 访问微服务 B 之前需要从授权服务器中获取 Access Token，才能携带 Access Token 访问微服务 B 中的 Restful API，如图 1 所示。微服务 A 使用客户端模式（Client Credentials Grant）的方式，从授权服务器获取 Access Token。目前微服务 A 通过 RestTemplate，从授权服务器获取 Access Token，并通过 Ehcache 来缓存 Access Token。"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="在 Spring Boot 中如何使用 OAuth 2.0 Client"><meta name=twitter:description content="背景 链接到标题 目前有两个微服务 A 和 B，微服务 A 访问微服务 B 之前需要从授权服务器中获取 Access Token，才能携带 Access Token 访问微服务 B 中的 Restful API，如图 1 所示。微服务 A 使用客户端模式（Client Credentials Grant）的方式，从授权服务器获取 Access Token。目前微服务 A 通过 RestTemplate，从授权服务器获取 Access Token，并通过 Ehcache 来缓存 Access Token。"><meta property="og:url" content="http://example.org/posts/spring-boot/how-to-use-oauth-2-client-in-spring-boot/"><meta property="og:site_name" content="墨客人生"><meta property="og:title" content="在 Spring Boot 中如何使用 OAuth 2.0 Client"><meta property="og:description" content="背景 链接到标题 目前有两个微服务 A 和 B，微服务 A 访问微服务 B 之前需要从授权服务器中获取 Access Token，才能携带 Access Token 访问微服务 B 中的 Restful API，如图 1 所示。微服务 A 使用客户端模式（Client Credentials Grant）的方式，从授权服务器获取 Access Token。目前微服务 A 通过 RestTemplate，从授权服务器获取 Access Token，并通过 Ehcache 来缓存 Access Token。"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-02-15T10:10:42+07:00"><meta property="article:modified_time" content="2025-02-15T10:10:42+07:00"><meta property="article:tag" content="Spring Security"><meta property="article:tag" content="Spring Boot"><meta property="article:tag" content="Oauth2 Client"><link rel=canonical href=http://example.org/posts/spring-boot/how-to-use-oauth-2-client-in-spring-boot/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.aa5ef26fa979d6793724ae2dbd71efa94fd16cb1c5c7db3b6651f21f9892a5fd.css integrity="sha256-ql7yb6l51nk3JK4tvXHvqU/RbLHFx9s7ZlHyH5iSpf0=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/img/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/img/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=http://example.org/>墨客人生
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/life/>生活</a></li><li class=navigation-item><a class=navigation-link href=/posts/>博客</a></li><li class=navigation-item><a class=navigation-link href=/about-me>关于我</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=http://example.org/posts/spring-boot/how-to-use-oauth-2-client-in-spring-boot/>在 Spring Boot 中如何使用 OAuth 2.0 Client</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2025-02-15T10:10:42+07:00>February 15, 2025
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
阅读时间：8 分钟
</span><span class=post-word-count>| 🍉 3978 字</span></div><div class=authors><i class="fa-solid fa-user" aria-hidden=true></i>
<a href=/authors/mervyn/>Mervyn</a></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/spring-security/>Spring Security</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/spring-boot/>Spring Boot</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/oauth2-client/>Oauth2 Client</a></span></div></div></header><div class=post-content><h1 id=背景>背景
<a class=heading-link href=#%e8%83%8c%e6%99%af><i class="fa-solid fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h1><p>目前有两个微服务 A 和 B，微服务 A 访问微服务 B 之前需要从授权服务器中获取 Access Token，才能携带 Access Token 访问微服务 B 中的 Restful API，如图 1 所示。微服务 A 使用客户端模式（Client Credentials Grant）的方式，从授权服务器获取 Access Token。目前微服务 A 通过 RestTemplate，从授权服务器获取 Access Token，并通过 Ehcache 来缓存 Access Token。</p><p><img src=/spring-boot/How-to-use-OAuth-2-Client-in-Spring-Boot/Current-statuation.svg alt=现状>
图 1 现状</p><p>但在目前的架构中，我们遇到了一个这样的问题，如图 2 所示。微服务 A 从授权服务器获取的 Access Token，它是具有失效的，比如它的 <code>expires_in</code> 值为 86400 秒（约 24 小时），表示 24 小时之后，该 Access Token 就会过期。微服务 A 在 Ehcache 中通过 Hard Code 的方式配置了缓存 Access Token 为 24 小时。这本来没有啥问题，但是有一天授权服务器侧将 Access Token 的过期时间从 24 小时调整至 1 小时，但此时微服务 A 没有收到这边变动的通知，当然也没有在微服务 A 侧进行同步的调整。这就导致微服务 A 中可能会缓存已经过期的 Access Token，从而导致微服务 A 调用微服务 B 失败。这样的事故固然有沟通的问题，但是我们也尝试是否有其他的解决方案。</p><p><img src=/spring-boot/How-to-use-OAuth-2-Client-in-Spring-Boot/incident.svg alt=事故>
图 2 事故</p><h1 id=解决方案>解决方案
<a class=heading-link href=#%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88><i class="fa-solid fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h1><p>曾考虑过动态根据从授权服务器获取的 Access Token 的过期时间，动态调整微服务 A 缓存 Access Token 的时间。这里仅仅需要保证微服务 A 缓存 Access Token 的时间小于 Access Token 的过期时间即可。但这需要手动完成这样的逻辑。幸运的是，我们发现了 Spring Security 中的 OAuth 2.0 Client，使用它可以自动完成对 Access Token 的管理（实现了上述逻辑，缓存 Access Token 和过期处理）。因此我们可以开箱即用，避免重复造轮子。</p><h2 id=oauth-20-client-是如何管理-access-token>OAuth 2.0 Client 是如何管理 Access Token
<a class=heading-link href=#oauth-20-client-%e6%98%af%e5%a6%82%e4%bd%95%e7%ae%a1%e7%90%86-access-token><i class="fa-solid fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><h3 id=oauth-20-client-是什么>OAuth 2.0 Client 是什么？
<a class=heading-link href=#oauth-20-client-%e6%98%af%e4%bb%80%e4%b9%88><i class="fa-solid fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h3><p><a href=https://docs.spring.io/spring-security/reference/servlet/oauth2/client/index.html class=external-link target=_blank rel=noopener>OAuth 2.0 Client</a> 是 Spring Security 中为了支持 <a href=https://datatracker.ietf.org/doc/html/rfc6749#section-1.1 class=external-link target=_blank rel=noopener>OAuth 2.0 Authorization Framework</a> 中定义的 Client Role 开发的一个特性。主要用于通过 OAuth 2.0 Client 从 OAuth 2.0 Authorization Server 获取 Access Token。</p><p>OAuth 2.0 Client 的核心功能支持多种客户端的授权模式，包括<a href=https://datatracker.ietf.org/doc/html/rfc6749#section-4.1 class=external-link target=_blank rel=noopener>授权码模式（authorization code）</a>和<a href=https://datatracker.ietf.org/doc/html/rfc6749#section-4.4 class=external-link target=_blank rel=noopener>客户端模式（client credentials）</a>以及<a href=https://datatracker.ietf.org/doc/html/rfc6749#section-4.3 class=external-link target=_blank rel=noopener>密码模式（resource owner password credentials）</a>等。</p><h3 id=oauth-20-client-对-access-token-的管理>OAuth 2.0 Client 对 Access Token 的管理
<a class=heading-link href=#oauth-20-client-%e5%af%b9-access-token-%e7%9a%84%e7%ae%a1%e7%90%86><i class="fa-solid fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h3><p>OAuth 2.0 Client 主要表 1 中的接口来对 Access Token 进行管理。对与这些接口或实现类的详细说明可以参考官方<a href=https://docs.spring.io/spring-security/reference/servlet/oauth2/client/core.html class=external-link target=_blank rel=noopener>Core Interfaces and Classes</a></p><table><thead><tr><th>接口</th><th>说明</th><th>实现类举例</th></tr></thead><tbody><tr><td>OAuth2AuthorizedClientManager</td><td>用来管理获取 Access Token 的整个流程。通过 OAuth2AuthorizedClientProvider 获取 Access Token。通过 OAuth2AuthorizedClientRepository 缓存或持久化 Access Token。唯一的方法为 authorize，用来获取授权。</td><td>DefaultOAuth2AuthorizedClientManager，用于 HttpServletRequest 上下文中的默认 OAuth2AuthorizedClientManager 实现。 AuthorizedClientServiceOAuth2AuthorizedClientManager 一个 OAuth2AuthorizedClientManager 的实现，能够在 HttpServletRequest 的上下文之外运行，例如在计划任务/后台线程中和/或在服务层中。</td></tr><tr><td>OAuth2AuthorizedClientRepository</td><td>用来缓存 Access Token。 loadAuthorizedClient 方法用来从缓存中获取 Access Token；saveAuthorizedClient 方法用户在得到新的 Access Token 之后，将其缓存或持久化；removeAuthorizedClient 方法用来移除缓存中的 Access Token。</td><td>HttpSessionOAuth2AuthorizedClientRepository，用于将 Access Token 缓存在 HttpSession 会话中。</td></tr><tr><td>OAuth2AuthorizedClientProvider</td><td>用来获取 Access Token。 authorize 方法先从入参中获取 Access Token，如果没有过期，则返回该 Access Token；如果过期，则重新从 Authorization Server 获取新的 Access Token。</td><td>ClientCredentialsOAuth2AuthorizedClientProvider，用于以客户端模式的方式从 Authorization Server 中获取 Access Token（如果缓存中 Access Token 以及过期的情况下）。</td></tr><tr><td>OAuth2AuthorizationSuccessHandler</td><td>从 Authorization Server 成功获取 Access Token （授权成功）之后的处理器。比如将 Access Token 缓存到 OAuth2AuthorizedClientRepository 中或其他后续操作。</td><td></td></tr><tr><td>OAuth2AuthorizedClient</td><td>代表一个 OAuth 2.0 &ldquo;Authorized Client&rdquo;。通常其中包含 Client 信息和后续获取到的 Access Token。</td><td></td></tr><tr><td>OAuth2AuthorizationFailureHandler</td><td>用来处理授权失败之后的处理器。比如从 Access Token 从 OAuth2AuthorizedClientRepository 中或其他后续操作。</td><td></td></tr></tbody></table><p>表 1 OAuth 2.0 Client 的主要接口</p><p>下面以客户端模式（client credentials grant）授权模式下的 OAuth 2.0 Client 为例，来具体说明 Access Token 的整个管理过程。通过 OAuth 2.0 Client 以客户端模式（client credentials grant）授权模式获取 Access Token 时，通常有两种使用场景。第一种的 Access Token 的 scope 是用户，每一个用户一个 Access Token。第二种的 Access Token 的 scope 是应用，每一个应用一个 Access Token。这两种的使用场景如图 3 所示。</p><p><img src=/spring-boot/How-to-use-OAuth-2-Client-in-Spring-Boot/btain-access-token-per-user-vs-per-application.svg alt="一个用户一个 Access Token VS 一个用户一个 Access Token">
图 3 一个用户一个 Access Token VS 一个用户一个 Access Token</p><p>在 Spring Security OAuth2 client 中通过不同的 OAuth2AuthorizedClientManager 实现类来完成相应的工作。第一种是通过 DefaultOAuth2AuthorizedClientManager，其工作原理时序图如图4 所示。第二种是通过 AuthorizedClientServiceOAuth2AuthorizedClientManager，其工作原理时序图如图 5 所示。</p><p>下面以第一种为示例，来详细说明其过程。</p><ol><li>我们的组件通过 DefaultOAuth2AuthorizedClientManager（OAuth2AuthorizedClientManager） 的 authorize 方法来尝试获取授权。</li><li>DefaultOAuth2AuthorizedClientManager（OAuth2AuthorizedClientManager）尝试通过 HttpSessionOAuth2AuthorizedClientRepository（OAuth2AuthorizedClientRepository）的 loadAuthorizedClient 方法，从缓存（HttpSession）中获取 OAuth2AuthorizedClient 对象（如果缓存中有 Access Token, 那么该对象中就会包含旧的 Access Token）。</li><li>DefaultOAuth2AuthorizedClientManager（OAuth2AuthorizedClientManager）通过 ClientCredentialsOAuth2AuthorizedClientProvider（OAuth2AuthorizedClientProvider）的 authorize 方法，判断 Access Token 是否过期。如何没有过期，则返回携带旧 Access Token 的 OAuth2AuthorizedClient 对象；如果以及过期，则从 Authorization Server 中重新获取新的 Access Token。</li><li>如果授权失败，DefaultOAuth2AuthorizedClientManager（OAuth2AuthorizedClientManager）通过 OAuth2AuthorizationFailureHandler 移除 HttpSessionOAuth2AuthorizedClientRepository（OAuth2AuthorizedClientRepository）中缓存的 Access Token。</li><li>如果授权成功，DefaultOAuth2AuthorizedClientManager（OAuth2AuthorizedClientManager）通过 OAuth2AuthorizationSuccessHandler 将新的 Access Token 重新缓存到 HttpSessionOAuth2AuthorizedClientRepository（OAuth2AuthorizedClientRepository）中。</li></ol><p><img src=/spring-boot/How-to-use-OAuth-2-Client-in-Spring-Boot/how-OAuth2AuthorizedClientManager-manage-access-token.png alt="对于每一个用户一个 Access Token 的情况，OAuth 2.0 Client 通过 DefaultOAuth2AuthorizedClientManager 管理 Access Token 的时序图"></p><p>图 4 对于每一个用户一个 Access Token 的情况，OAuth 2.0 Client 通过 DefaultOAuth2AuthorizedClientManager 管理 Access Token 的时序图</p><p><img src=/spring-boot/How-to-use-OAuth-2-Client-in-Spring-Boot/how-AuthorizedClientServiceOAuth2AuthorizedClientManager-works.png alt="对于每一个应用一个 Access Token 的情况，OAuth 2.0 Client 通过 AuthorizedClientServiceOAuth2AuthorizedClientManager 管理 Access Token 的时序图"></p><p>图 5 对于每一个应用一个 Access Token 的情况，OAuth 2.0 Client 通过 AuthorizedClientServiceOAuth2AuthorizedClientManager 管理 Access Token 的时序图</p><p>对于背景中描述的场景，我们符合第二种（每一个应用一个 Access Token）。</p><h2 id=oauth-20-client-的使用>OAuth 2.0 Client 的使用
<a class=heading-link href=#oauth-20-client-%e7%9a%84%e4%bd%bf%e7%94%a8><i class="fa-solid fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><p>下面以客户端授权模式为 client_credentials__grant 并且客户端认证方式为 client_secret_post 的情况为例，来说明如何使用 OAuth 2.0 Client。使用 OAuth 2.0 Client 时，需要在 application.yaml 中配置 client 信息和指定 OAuth2AuthorizedClientProvider 采用的客户端授权模式。</p><h3 id=引入依赖>引入依赖
<a class=heading-link href=#%e5%bc%95%e5%85%a5%e4%be%9d%e8%b5%96><i class="fa-solid fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h3><p>如代码清单 1 所示，除了其他依赖外我们重点要引入 <code>spring-security-oauth2-client</code> 依赖项。</p><p>代码清单 1：引入依赖 pom.xml</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#7ee787>&lt;dependencies&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-web --&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#7ee787>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;artifactId&gt;</span>spring-boot-starter-web<span style=color:#7ee787>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#7ee787>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;artifactId&gt;</span>spring-boot-starter-security<span style=color:#7ee787>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>&lt;!-- https://mvnrepository.com/artifact/org.springframework.security/spring-security-oauth2-client --&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;groupId&gt;</span>org.springframework.security<span style=color:#7ee787>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;artifactId&gt;</span>spring-security-oauth2-client<span style=color:#7ee787>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>&lt;!-- https://mvnrepository.com/artifact/com.squareup.okhttp3/mockwebserver --&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;groupId&gt;</span>com.squareup.okhttp3<span style=color:#7ee787>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;artifactId&gt;</span>mockwebserver<span style=color:#7ee787>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;version&gt;</span>4.12.0<span style=color:#7ee787>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;scope&gt;</span>test<span style=color:#7ee787>&lt;/scope&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#7ee787>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;artifactId&gt;</span>spring-boot-starter-test<span style=color:#7ee787>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#7ee787>&lt;/dependencies&gt;</span>
</span></span></code></pre></div><h3 id=配置-applicationyaml-中配置-client-信息>配置 application.yaml 中配置 client 信息
<a class=heading-link href=#%e9%85%8d%e7%bd%ae-applicationyaml-%e4%b8%ad%e9%85%8d%e7%bd%ae-client-%e4%bf%a1%e6%81%af><i class="fa-solid fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h3><p>如代码清单 2 所示，在 application.yaml 中需要配置 registration 和 provider。</p><ul><li>registration<ul><li>registration 中注册一个名为 <code>some-client</code> 的 client。<ul><li>provider: 该 client 下面包含了 <code>provider</code> 需要与 <code>spring.security.oauth2.client.provider</code> 下的某个 provider 一致。如代码清单 2 中的 <code>spring.security.oauth2.client.registration.some-client.provider</code> 的值与 <code>spring.security.oauth2.client.provider.some-provider</code> 一致。</li><li>client-id: client 的 id</li><li>client-secret: client secret</li><li>authorization-grant-type: 用来表示客户端授权的模式。可选择值有 authorization_code_grant,client_credentials__grant,implicit_grant,resource_owner_password_credentials_grant。</li><li>client-authentication-method：用来表示认证的方式。可选值有 client_secret_basic，client_secret_post，client_secret_jwt，private_key_jwt，tls_client_auth，self_signed_tls_client_auth。</li></ul></li></ul></li><li>provider<ul><li>some-provider: provider 的名字。可以自定义。</li><li>token-uri: 获取授权的地址。</li></ul></li></ul><p>代码清单 2：Oauth 2.0 Client 的配置 application.yaml</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>spring</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>security</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>oauth2</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>client</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>registration</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>some-client</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>provider</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>some-provider</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>client-id</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>custom-client-id</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>client-secret</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>custom-client-secret</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>authorization-grant-type</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>client_credentials</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>client-authentication-method</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>client_secret_post</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>scope</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span>- <span style=color:#a5d6ff>&#34;read&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>provider</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>some-provider</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>token-uri</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>http://localhost:9000/oauth2/token</span><span style=color:#6e7681>
</span></span></span></code></pre></div><h3 id=指定-oauth2authorizedclientprovider-的授权模式>指定 OAuth2AuthorizedClientProvider 的授权模式
<a class=heading-link href=#%e6%8c%87%e5%ae%9a-oauth2authorizedclientprovider-%e7%9a%84%e6%8e%88%e6%9d%83%e6%a8%a1%e5%bc%8f><i class="fa-solid fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h3><p>如代码清单 3 所示，配置和指定 OAuth2AuthorizedClientProvider 的客户端授权模式。</p><p>代码清单 3：用来指定 OAuth2AuthorizedClientProvider 的客户端授权模式 Oauth2ClientConfig.java</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>package</span><span style=color:#6e7681> </span><span style=color:#ff7b72>com.mervyn.springboot.learn.config</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.context.annotation.Bean</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.context.annotation.Configuration</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.security.oauth2.client.AuthorizedClientServiceOAuth2AuthorizedClientManager</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.security.oauth2.client.OAuth2AuthorizedClientManager</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.security.oauth2.client.OAuth2AuthorizedClientProvider</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.security.oauth2.client.OAuth2AuthorizedClientProviderBuilder</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.security.oauth2.client.OAuth2AuthorizedClientService</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.security.oauth2.client.registration.ClientRegistrationRepository</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.security.oauth2.client.web.client.OAuth2ClientHttpRequestInterceptor</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.web.client.RestClient</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#d2a8ff;font-weight:700>@Configuration</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>RestClientConfig</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#d2a8ff;font-weight:700>@Bean</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span>OAuth2AuthorizedClientManager<span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>authorizedClientManager</span>(<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span>ClientRegistrationRepository<span style=color:#6e7681> </span>clientRegistrationRepository,<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span>OAuth2AuthorizedClientService<span style=color:#6e7681> </span>OAuth2AuthorizedClientService)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>OAuth2AuthorizedClientProvider<span style=color:#6e7681> </span>authorizedClientProvider<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>OAuth2AuthorizedClientProviderBuilder.builder()<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                    </span>.clientCredentials()<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                    </span>.build();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>AuthorizedClientServiceOAuth2AuthorizedClientManager<span style=color:#6e7681> </span>authorizedClientManager<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#ff7b72>new</span><span style=color:#6e7681> </span>AuthorizedClientServiceOAuth2AuthorizedClientManager(clientRegistrationRepository,<span style=color:#6e7681> </span>OAuth2AuthorizedClientService);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>authorizedClientManager.setAuthorizedClientProvider(authorizedClientProvider);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>return</span><span style=color:#6e7681> </span>authorizedClientManager;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#d2a8ff;font-weight:700>@Bean</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span>RestClient<span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>restClient</span>(OAuth2AuthorizedClientManager<span style=color:#6e7681> </span>authorizedClientManager)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>OAuth2ClientHttpRequestInterceptor<span style=color:#6e7681> </span>requestInterceptor<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#ff7b72>new</span><span style=color:#6e7681> </span>OAuth2ClientHttpRequestInterceptor(authorizedClientManager);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>return</span><span style=color:#6e7681> </span>RestClient.builder().requestInterceptor(requestInterceptor).build();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>}<span style=color:#6e7681>
</span></span></span></code></pre></div><h3 id=测试>测试
<a class=heading-link href=#%e6%b5%8b%e8%af%95><i class="fa-solid fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h3><p>为了测试是否能从 Authorization Server 获取到 Access Token。通过 <code>/token-test</code>接口暴露 Access Token 的值，因此这里我们通过 MockMvc 来测试该接口的返回值。在这里我们通过 MockWebServer 来模拟 Authorization Server 的行为，并且通过 takeRequest 方法获取 OAuth2AuthorizedClientProvider 发送的请求是否符合期望。
代码清单 4: 对获取 Access Token 的接口进行集成测试 AuthorizationClientTest.java</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>package</span><span style=color:#6e7681> </span><span style=color:#ff7b72>com.mervyn.springboot.learn</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>com.fasterxml.jackson.core.JsonProcessingException</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>com.fasterxml.jackson.databind.json.JsonMapper</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>okhttp3.mockwebserver.Dispatcher</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>okhttp3.mockwebserver.MockResponse</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>okhttp3.mockwebserver.MockWebServer</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>okhttp3.mockwebserver.RecordedRequest</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.hamcrest.core.Is</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.junit.jupiter.api.AfterAll</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.junit.jupiter.api.AfterEach</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.junit.jupiter.api.BeforeAll</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.junit.jupiter.api.Test</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.beans.factory.annotation.Autowired</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.boot.test.context.SpringBootTest</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.http.MediaType</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.security.oauth2.client.OAuth2AuthorizedClientService</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.test.web.servlet.MockMvc</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.test.web.servlet.MvcResult</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.test.web.servlet.request.MockMvcRequestBuilders</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>java.io.IOException</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>java.util.HashMap</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>java.util.Map</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>java.util.UUID</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>java.util.concurrent.TimeUnit</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.hamcrest.CoreMatchers.equalTo</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.hamcrest.MatcherAssert.assertThat</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.hamcrest.Matchers.containsString</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.hamcrest.Matchers.not</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.hamcrest.Matchers.notNullValue</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.hamcrest.Matchers.nullValue</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.test.web.servlet.result.MockMvcResultMatchers.content</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.test.web.servlet.result.MockMvcResultMatchers.status</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#d2a8ff;font-weight:700>@SpringBootTest</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#d2a8ff;font-weight:700>@AutoConfigureMockMvc</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>AuthorizationClientTest</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span><span style=color:#ff7b72>static</span><span style=color:#6e7681> </span>MockWebServer<span style=color:#6e7681> </span>server;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#d2a8ff;font-weight:700>@Autowired</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span>MockMvc<span style=color:#6e7681> </span>mockMvc;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#d2a8ff;font-weight:700>@Autowired</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>private</span><span style=color:#6e7681>  </span>OAuth2AuthorizedClientService<span style=color:#6e7681> </span>authorizedClientService;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#d2a8ff;font-weight:700>@BeforeAll</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>setup</span>()<span style=color:#6e7681> </span><span style=color:#ff7b72>throws</span><span style=color:#6e7681> </span>IOException<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>server<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#ff7b72>new</span><span style=color:#6e7681> </span>MockWebServer();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>final</span><span style=color:#6e7681> </span>Dispatcher<span style=color:#6e7681> </span>dispatcher<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#ff7b72>new</span><span style=color:#6e7681> </span>Dispatcher()<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#d2a8ff;font-weight:700>@Override</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span>MockResponse<span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>dispatch</span>(RecordedRequest<span style=color:#6e7681> </span>request)<span style=color:#6e7681> </span><span style=color:#ff7b72>throws</span><span style=color:#6e7681> </span>InterruptedException<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>switch</span><span style=color:#6e7681> </span>(request.getPath())<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#ff7b72>case</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;/oauth2/token&#34;</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>Map<span style=color:#ff7b72;font-weight:700>&lt;</span>String,<span style=color:#6e7681> </span>String<span style=color:#ff7b72;font-weight:700>&gt;</span><span style=color:#6e7681> </span>responseMap<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#ff7b72>new</span><span style=color:#6e7681> </span>HashMap<span style=color:#ff7b72;font-weight:700>&lt;&gt;</span>();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>responseMap.put(<span style=color:#a5d6ff>&#34;access_token&#34;</span>,<span style=color:#6e7681> </span>UUID.randomUUID().toString());<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>responseMap.put(<span style=color:#a5d6ff>&#34;scope&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;read&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>responseMap.put(<span style=color:#a5d6ff>&#34;token_type&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;Bearer&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>responseMap.put(<span style=color:#a5d6ff>&#34;expires_in&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;120&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>JsonMapper<span style=color:#6e7681> </span>jsonMapper<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#ff7b72>new</span><span style=color:#6e7681> </span>JsonMapper();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>String<span style=color:#6e7681> </span>response<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>buildJsonResponse(jsonMapper,<span style=color:#6e7681> </span>responseMap);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#ff7b72>return</span><span style=color:#6e7681> </span><span style=color:#ff7b72>new</span><span style=color:#6e7681> </span>MockResponse()<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                    </span>.addHeader(<span style=color:#a5d6ff>&#34;Content-Type&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;application/json; charset=utf-8&#34;</span>)<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                    </span>.setResponseCode(200)<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                    </span>.setBody(response);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>return</span><span style=color:#6e7681> </span><span style=color:#ff7b72>new</span><span style=color:#6e7681> </span>MockResponse().setResponseCode(404);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>};<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>server.setDispatcher(dispatcher);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>server.start(9000);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span><span style=color:#ff7b72>static</span><span style=color:#6e7681> </span>String<span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>buildJsonResponse</span>(JsonMapper<span style=color:#6e7681> </span>jsonMapper,<span style=color:#6e7681> </span>Map<span style=color:#ff7b72;font-weight:700>&lt;</span>String,<span style=color:#6e7681> </span>String<span style=color:#ff7b72;font-weight:700>&gt;</span><span style=color:#6e7681> </span>responseMap)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>String<span style=color:#6e7681> </span>response<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#79c0ff>null</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>try</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>response<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>jsonMapper.writeValueAsString(responseMap);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681> </span><span style=color:#ff7b72>catch</span><span style=color:#6e7681> </span>(JsonProcessingException<span style=color:#6e7681> </span>e)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>return</span><span style=color:#6e7681> </span>response;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#d2a8ff;font-weight:700>@Test</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>shouldReturnAccessTokenWhenRetrieveAccessToken</span>()<span style=color:#6e7681> </span><span style=color:#ff7b72>throws</span><span style=color:#6e7681> </span>Exception<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>mockMvc.perform(MockMvcRequestBuilders.get(<span style=color:#a5d6ff>&#34;/token-test&#34;</span>))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andExpect(status().isOk())<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andExpect(content().string(notNullValue()))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andExpect(content().string(not(<span style=color:#a5d6ff>&#34;&#34;</span>)));<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>RecordedRequest<span style=color:#6e7681> </span>request<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>server.takeRequest();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>assertThat(request.getHeaders().get(<span style=color:#a5d6ff>&#34;Content-Type&#34;</span>),<span style=color:#6e7681> </span>containsString(MediaType.APPLICATION_FORM_URLENCODED_VALUE));<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>String<span style=color:#6e7681> </span>bodyContent<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>request.getBody().readUtf8();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>assertThat(bodyContent,<span style=color:#6e7681> </span>containsString(<span style=color:#a5d6ff>&#34;client_id=custom-client-id&#34;</span>));<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>assertThat(bodyContent,<span style=color:#6e7681> </span>containsString(<span style=color:#a5d6ff>&#34;client_secret=custom-client-secret&#34;</span>));<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>assertThat(bodyContent,<span style=color:#6e7681> </span>containsString(<span style=color:#a5d6ff>&#34;grant_type=client_credentials&#34;</span>));<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>assertThat(bodyContent,<span style=color:#6e7681> </span>containsString(<span style=color:#a5d6ff>&#34;scope=read&#34;</span>));<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#d2a8ff;font-weight:700>@Test</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>shouldReturnSameAccessTokenAndCallAuthorizationServerOnlyOnceWhenAccessTokenIsNotExpired</span>()<span style=color:#6e7681> </span><span style=color:#ff7b72>throws</span><span style=color:#6e7681> </span>Exception<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>MvcResult<span style=color:#6e7681> </span>mvcResult1<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>mockMvc.perform(MockMvcRequestBuilders.get(<span style=color:#a5d6ff>&#34;/token-test&#34;</span>))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andExpect(status().isOk())<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andExpect(content().string(notNullValue()))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andExpect(content().string(not(<span style=color:#a5d6ff>&#34;&#34;</span>)))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andReturn();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>MvcResult<span style=color:#6e7681> </span>mvcResult2<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>mockMvc.perform(MockMvcRequestBuilders.get(<span style=color:#a5d6ff>&#34;/token-test&#34;</span>))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andExpect(status().isOk())<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andExpect(content().string(notNullValue()))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andExpect(content().string(not(<span style=color:#a5d6ff>&#34;&#34;</span>)))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andReturn();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>String<span style=color:#6e7681> </span>response1<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>mvcResult1.getResponse().getContentAsString();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>String<span style=color:#6e7681> </span>response2<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>mvcResult2.getResponse().getContentAsString();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>assertThat(response1,<span style=color:#6e7681> </span>Is.is(response2));<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>RecordedRequest<span style=color:#6e7681> </span>request<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>server.takeRequest(3,<span style=color:#6e7681> </span>TimeUnit.MILLISECONDS);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>assertThat(request,<span style=color:#6e7681> </span>notNullValue());<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>RecordedRequest<span style=color:#6e7681> </span>request1<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>server.takeRequest(3,<span style=color:#6e7681> </span>TimeUnit.MILLISECONDS);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>assertThat(request1,<span style=color:#6e7681> </span>nullValue());<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#d2a8ff;font-weight:700>@Test</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>shouldReturnDifferentAccessTokenCallAuthorizationServerTwiceWhenAccessTokenIsExpired</span>()<span style=color:#6e7681> </span><span style=color:#ff7b72>throws</span><span style=color:#6e7681> </span>Exception<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>MvcResult<span style=color:#6e7681> </span>mvcResult1<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>mockMvc.perform(MockMvcRequestBuilders.get(<span style=color:#a5d6ff>&#34;/token-test&#34;</span>))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andExpect(status().isOk())<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andExpect(content().string(notNullValue()))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andExpect(content().string(not(<span style=color:#a5d6ff>&#34;&#34;</span>)))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andReturn();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>RecordedRequest<span style=color:#6e7681> </span>request<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>server.takeRequest(3,<span style=color:#6e7681> </span>TimeUnit.MILLISECONDS);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>assertThat(request,<span style=color:#6e7681> </span>notNullValue());<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>TimeUnit.SECONDS.sleep(140);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>MvcResult<span style=color:#6e7681> </span>mvcResult2<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>mockMvc.perform(MockMvcRequestBuilders.get(<span style=color:#a5d6ff>&#34;/token-test&#34;</span>))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andExpect(status().isOk())<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andExpect(content().string(notNullValue()))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andExpect(content().string(not(<span style=color:#a5d6ff>&#34;&#34;</span>)))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andReturn();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>RecordedRequest<span style=color:#6e7681> </span>request1<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>server.takeRequest(3,<span style=color:#6e7681> </span>TimeUnit.MILLISECONDS);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>assertThat(request1,<span style=color:#6e7681> </span>notNullValue());<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>String<span style=color:#6e7681> </span>response1<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>mvcResult1.getResponse().getContentAsString();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>String<span style=color:#6e7681> </span>response2<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>mvcResult2.getResponse().getContentAsString();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>assertThat(response1,<span style=color:#6e7681> </span>not(equalTo(response2)));<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#d2a8ff;font-weight:700>@AfterEach</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>removeAccessTokenFromCache</span>()<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>authorizedClientService.removeAuthorizedClient(<span style=color:#a5d6ff>&#34;some-client&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;test&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#d2a8ff;font-weight:700>@AfterAll</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>teardown</span>()<span style=color:#6e7681> </span><span style=color:#ff7b72>throws</span><span style=color:#6e7681> </span>IOException<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>server.shutdown();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>}<span style=color:#6e7681>
</span></span></span></code></pre></div></div><div style="text-align:center;color:#a9a9a9;width:50%;margin:0 auto"><p>本作品采用<a href=http://creativecommons.org/licenses/by-nc-nd/4.0/ style=color:#a9a9a9>知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可</p></div><div style="border-bottom-style:dashed;border-bottom-style:inset;border-bottom-width:2px;width:50%;margin:0 auto"></div><footer><div class=comments><script>let getTheme=window.localStorage&&window.localStorage.getItem("colorscheme");getTheme=getTheme??"light";let s=document.createElement("script");s.src="https://giscus.app/client.js",s.setAttribute("data-repo","csmervyn/csmervyn.github.io"),s.setAttribute("data-repo-id","R_kgDOGbYn4A"),s.setAttribute("data-category","Announcements"),s.setAttribute("data-category-id","DIC_kwDOGbYn4M4CWQYR"),s.setAttribute("data-mapping","pathname"),s.setAttribute("data-term",""),s.setAttribute("data-strict","0"),s.setAttribute("data-reactions-enabled","1"),s.setAttribute("data-emit-metadata","0"),s.setAttribute("data-input-position","bottom"),s.setAttribute("data-theme",getTheme),s.setAttribute("data-lang","zh-CN"),s.setAttribute("data-loading",""),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.comments").innerHTML="",document.querySelector("div.comments").appendChild(s)</script></div></footer></article></section></div><footer class=footer><section class=container>©
2019 -
2025
Mervyn
·
技术支持 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>