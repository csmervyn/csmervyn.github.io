<!doctype html><html lang=zh-cn><head><title>åœ¨ Spring Boot ä¸­å¦‚ä½•ä½¿ç”¨ OAuth 2.0 Client Â· å¢¨å®¢äººç”Ÿ</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Mervyn"><meta name=description content="
  èƒŒæ™¯
  
    
    é“¾æ¥åˆ°æ ‡é¢˜
  

ç›®å‰æœ‰ä¸¤ä¸ªå¾®æœåŠ¡ A å’Œ Bï¼Œå¾®æœåŠ¡ A è®¿é—®å¾®æœåŠ¡ B ä¹‹å‰éœ€è¦ä»æˆæƒæœåŠ¡å™¨ä¸­è·å– Access Tokenï¼Œæ‰èƒ½æºå¸¦ Access Token è®¿é—®å¾®æœåŠ¡ B ä¸­çš„ Restful APIï¼Œå¦‚å›¾ 1 æ‰€ç¤ºã€‚å¾®æœåŠ¡ A ä½¿ç”¨å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆClient Credentials Grantï¼‰çš„æ–¹å¼ï¼Œä»æˆæƒæœåŠ¡å™¨è·å– Access Tokenã€‚ç›®å‰å¾®æœåŠ¡ A é€šè¿‡ RestTemplateï¼Œä»æˆæƒæœåŠ¡å™¨è·å– Access Tokenï¼Œå¹¶é€šè¿‡ Ehcache æ¥ç¼“å­˜ Access Tokenã€‚"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="åœ¨ Spring Boot ä¸­å¦‚ä½•ä½¿ç”¨ OAuth 2.0 Client"><meta name=twitter:description content="èƒŒæ™¯ é“¾æ¥åˆ°æ ‡é¢˜ ç›®å‰æœ‰ä¸¤ä¸ªå¾®æœåŠ¡ A å’Œ Bï¼Œå¾®æœåŠ¡ A è®¿é—®å¾®æœåŠ¡ B ä¹‹å‰éœ€è¦ä»æˆæƒæœåŠ¡å™¨ä¸­è·å– Access Tokenï¼Œæ‰èƒ½æºå¸¦ Access Token è®¿é—®å¾®æœåŠ¡ B ä¸­çš„ Restful APIï¼Œå¦‚å›¾ 1 æ‰€ç¤ºã€‚å¾®æœåŠ¡ A ä½¿ç”¨å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆClient Credentials Grantï¼‰çš„æ–¹å¼ï¼Œä»æˆæƒæœåŠ¡å™¨è·å– Access Tokenã€‚ç›®å‰å¾®æœåŠ¡ A é€šè¿‡ RestTemplateï¼Œä»æˆæƒæœåŠ¡å™¨è·å– Access Tokenï¼Œå¹¶é€šè¿‡ Ehcache æ¥ç¼“å­˜ Access Tokenã€‚"><meta property="og:url" content="http://example.org/posts/spring-boot/how-to-use-oauth-2-client-in-spring-boot/"><meta property="og:site_name" content="å¢¨å®¢äººç”Ÿ"><meta property="og:title" content="åœ¨ Spring Boot ä¸­å¦‚ä½•ä½¿ç”¨ OAuth 2.0 Client"><meta property="og:description" content="èƒŒæ™¯ é“¾æ¥åˆ°æ ‡é¢˜ ç›®å‰æœ‰ä¸¤ä¸ªå¾®æœåŠ¡ A å’Œ Bï¼Œå¾®æœåŠ¡ A è®¿é—®å¾®æœåŠ¡ B ä¹‹å‰éœ€è¦ä»æˆæƒæœåŠ¡å™¨ä¸­è·å– Access Tokenï¼Œæ‰èƒ½æºå¸¦ Access Token è®¿é—®å¾®æœåŠ¡ B ä¸­çš„ Restful APIï¼Œå¦‚å›¾ 1 æ‰€ç¤ºã€‚å¾®æœåŠ¡ A ä½¿ç”¨å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆClient Credentials Grantï¼‰çš„æ–¹å¼ï¼Œä»æˆæƒæœåŠ¡å™¨è·å– Access Tokenã€‚ç›®å‰å¾®æœåŠ¡ A é€šè¿‡ RestTemplateï¼Œä»æˆæƒæœåŠ¡å™¨è·å– Access Tokenï¼Œå¹¶é€šè¿‡ Ehcache æ¥ç¼“å­˜ Access Tokenã€‚"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-02-15T10:10:42+07:00"><meta property="article:modified_time" content="2025-02-15T10:10:42+07:00"><meta property="article:tag" content="Spring Security"><meta property="article:tag" content="Spring Boot"><meta property="article:tag" content="Oauth2 Client"><link rel=canonical href=http://example.org/posts/spring-boot/how-to-use-oauth-2-client-in-spring-boot/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.26a83dcefaf34339737bf29f77b17753bab5e60782b1ca9ba200abbb73b48cb0.css integrity="sha256-Jqg9zvrzQzlze/Kfd7F3U7q15geCscqbogCru3O0jLA=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/img/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/img/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=http://example.org/>å¢¨å®¢äººç”Ÿ
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/life/>ç”Ÿæ´»</a></li><li class=navigation-item><a class=navigation-link href=/posts/>åšå®¢</a></li><li class=navigation-item><a class=navigation-link href=/about-me>å…³äºæˆ‘</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=http://example.org/posts/spring-boot/how-to-use-oauth-2-client-in-spring-boot/>åœ¨ Spring Boot ä¸­å¦‚ä½•ä½¿ç”¨ OAuth 2.0 Client</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2025-02-15T10:10:42+07:00>February 15, 2025
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
é˜…è¯»æ—¶é—´ï¼š8 åˆ†é’Ÿ
</span><span class=post-word-count>| ğŸ‰ 3978 å­—</span></div><div class=authors><i class="fa-solid fa-user" aria-hidden=true></i>
<a href=/authors/mervyn/>Mervyn</a></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/spring-security/>Spring Security</a>
</span><span class=separator>â€¢</span>
<span class=tag><a href=/tags/spring-boot/>Spring Boot</a>
</span><span class=separator>â€¢</span>
<span class=tag><a href=/tags/oauth2-client/>Oauth2 Client</a></span></div></div></header><div class=post-content><h1 id=èƒŒæ™¯>èƒŒæ™¯
<a class=heading-link href=#%e8%83%8c%e6%99%af><i class="fa-solid fa-link" aria-hidden=true title=é“¾æ¥åˆ°æ ‡é¢˜></i>
<span class=sr-only>é“¾æ¥åˆ°æ ‡é¢˜</span></a></h1><p>ç›®å‰æœ‰ä¸¤ä¸ªå¾®æœåŠ¡ A å’Œ Bï¼Œå¾®æœåŠ¡ A è®¿é—®å¾®æœåŠ¡ B ä¹‹å‰éœ€è¦ä»æˆæƒæœåŠ¡å™¨ä¸­è·å– Access Tokenï¼Œæ‰èƒ½æºå¸¦ Access Token è®¿é—®å¾®æœåŠ¡ B ä¸­çš„ Restful APIï¼Œå¦‚å›¾ 1 æ‰€ç¤ºã€‚å¾®æœåŠ¡ A ä½¿ç”¨å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆClient Credentials Grantï¼‰çš„æ–¹å¼ï¼Œä»æˆæƒæœåŠ¡å™¨è·å– Access Tokenã€‚ç›®å‰å¾®æœåŠ¡ A é€šè¿‡ RestTemplateï¼Œä»æˆæƒæœåŠ¡å™¨è·å– Access Tokenï¼Œå¹¶é€šè¿‡ Ehcache æ¥ç¼“å­˜ Access Tokenã€‚</p><p><img src=/spring-boot/How-to-use-OAuth-2-Client-in-Spring-Boot/Current-statuation.svg alt=ç°çŠ¶>
å›¾ 1 ç°çŠ¶</p><p>ä½†åœ¨ç›®å‰çš„æ¶æ„ä¸­ï¼Œæˆ‘ä»¬é‡åˆ°äº†ä¸€ä¸ªè¿™æ ·çš„é—®é¢˜ï¼Œå¦‚å›¾ 2 æ‰€ç¤ºã€‚å¾®æœåŠ¡ A ä»æˆæƒæœåŠ¡å™¨è·å–çš„ Access Tokenï¼Œå®ƒæ˜¯å…·æœ‰å¤±æ•ˆçš„ï¼Œæ¯”å¦‚å®ƒçš„ <code>expires_in</code> å€¼ä¸º 86400 ç§’ï¼ˆçº¦ 24 å°æ—¶ï¼‰ï¼Œè¡¨ç¤º 24 å°æ—¶ä¹‹åï¼Œè¯¥ Access Token å°±ä¼šè¿‡æœŸã€‚å¾®æœåŠ¡ A åœ¨ Ehcache ä¸­é€šè¿‡ Hard Code çš„æ–¹å¼é…ç½®äº†ç¼“å­˜ Access Token ä¸º 24 å°æ—¶ã€‚è¿™æœ¬æ¥æ²¡æœ‰å•¥é—®é¢˜ï¼Œä½†æ˜¯æœ‰ä¸€å¤©æˆæƒæœåŠ¡å™¨ä¾§å°† Access Token çš„è¿‡æœŸæ—¶é—´ä» 24 å°æ—¶è°ƒæ•´è‡³ 1 å°æ—¶ï¼Œä½†æ­¤æ—¶å¾®æœåŠ¡ A æ²¡æœ‰æ”¶åˆ°è¿™è¾¹å˜åŠ¨çš„é€šçŸ¥ï¼Œå½“ç„¶ä¹Ÿæ²¡æœ‰åœ¨å¾®æœåŠ¡ A ä¾§è¿›è¡ŒåŒæ­¥çš„è°ƒæ•´ã€‚è¿™å°±å¯¼è‡´å¾®æœåŠ¡ A ä¸­å¯èƒ½ä¼šç¼“å­˜å·²ç»è¿‡æœŸçš„ Access Tokenï¼Œä»è€Œå¯¼è‡´å¾®æœåŠ¡ A è°ƒç”¨å¾®æœåŠ¡ B å¤±è´¥ã€‚è¿™æ ·çš„äº‹æ•…å›ºç„¶æœ‰æ²Ÿé€šçš„é—®é¢˜ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿå°è¯•æ˜¯å¦æœ‰å…¶ä»–çš„è§£å†³æ–¹æ¡ˆã€‚</p><p><img src=/spring-boot/How-to-use-OAuth-2-Client-in-Spring-Boot/incident.svg alt=äº‹æ•…>
å›¾ 2 äº‹æ•…</p><h1 id=è§£å†³æ–¹æ¡ˆ>è§£å†³æ–¹æ¡ˆ
<a class=heading-link href=#%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88><i class="fa-solid fa-link" aria-hidden=true title=é“¾æ¥åˆ°æ ‡é¢˜></i>
<span class=sr-only>é“¾æ¥åˆ°æ ‡é¢˜</span></a></h1><p>æ›¾è€ƒè™‘è¿‡åŠ¨æ€æ ¹æ®ä»æˆæƒæœåŠ¡å™¨è·å–çš„ Access Token çš„è¿‡æœŸæ—¶é—´ï¼ŒåŠ¨æ€è°ƒæ•´å¾®æœåŠ¡ A ç¼“å­˜ Access Token çš„æ—¶é—´ã€‚è¿™é‡Œä»…ä»…éœ€è¦ä¿è¯å¾®æœåŠ¡ A ç¼“å­˜ Access Token çš„æ—¶é—´å°äº Access Token çš„è¿‡æœŸæ—¶é—´å³å¯ã€‚ä½†è¿™éœ€è¦æ‰‹åŠ¨å®Œæˆè¿™æ ·çš„é€»è¾‘ã€‚å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬å‘ç°äº† Spring Security ä¸­çš„ OAuth 2.0 Clientï¼Œä½¿ç”¨å®ƒå¯ä»¥è‡ªåŠ¨å®Œæˆå¯¹ Access Token çš„ç®¡ç†ï¼ˆå®ç°äº†ä¸Šè¿°é€»è¾‘ï¼Œç¼“å­˜ Access Token å’Œè¿‡æœŸå¤„ç†ï¼‰ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥å¼€ç®±å³ç”¨ï¼Œé¿å…é‡å¤é€ è½®å­ã€‚</p><h2 id=oauth-20-client-æ˜¯å¦‚ä½•ç®¡ç†-access-token>OAuth 2.0 Client æ˜¯å¦‚ä½•ç®¡ç† Access Token
<a class=heading-link href=#oauth-20-client-%e6%98%af%e5%a6%82%e4%bd%95%e7%ae%a1%e7%90%86-access-token><i class="fa-solid fa-link" aria-hidden=true title=é“¾æ¥åˆ°æ ‡é¢˜></i>
<span class=sr-only>é“¾æ¥åˆ°æ ‡é¢˜</span></a></h2><h3 id=oauth-20-client-æ˜¯ä»€ä¹ˆ>OAuth 2.0 Client æ˜¯ä»€ä¹ˆï¼Ÿ
<a class=heading-link href=#oauth-20-client-%e6%98%af%e4%bb%80%e4%b9%88><i class="fa-solid fa-link" aria-hidden=true title=é“¾æ¥åˆ°æ ‡é¢˜></i>
<span class=sr-only>é“¾æ¥åˆ°æ ‡é¢˜</span></a></h3><p><a href=https://docs.spring.io/spring-security/reference/servlet/oauth2/client/index.html class=external-link target=_blank rel=noopener>OAuth 2.0 Client</a> æ˜¯ Spring Security ä¸­ä¸ºäº†æ”¯æŒ <a href=https://datatracker.ietf.org/doc/html/rfc6749#section-1.1 class=external-link target=_blank rel=noopener>OAuth 2.0 Authorization Framework</a> ä¸­å®šä¹‰çš„ Client Role å¼€å‘çš„ä¸€ä¸ªç‰¹æ€§ã€‚ä¸»è¦ç”¨äºé€šè¿‡ OAuth 2.0 Client ä» OAuth 2.0 Authorization Server è·å– Access Tokenã€‚</p><p>OAuth 2.0 Client çš„æ ¸å¿ƒåŠŸèƒ½æ”¯æŒå¤šç§å®¢æˆ·ç«¯çš„æˆæƒæ¨¡å¼ï¼ŒåŒ…æ‹¬<a href=https://datatracker.ietf.org/doc/html/rfc6749#section-4.1 class=external-link target=_blank rel=noopener>æˆæƒç æ¨¡å¼ï¼ˆauthorization codeï¼‰</a>å’Œ<a href=https://datatracker.ietf.org/doc/html/rfc6749#section-4.4 class=external-link target=_blank rel=noopener>å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆclient credentialsï¼‰</a>ä»¥åŠ<a href=https://datatracker.ietf.org/doc/html/rfc6749#section-4.3 class=external-link target=_blank rel=noopener>å¯†ç æ¨¡å¼ï¼ˆresource owner password credentialsï¼‰</a>ç­‰ã€‚</p><h3 id=oauth-20-client-å¯¹-access-token-çš„ç®¡ç†>OAuth 2.0 Client å¯¹ Access Token çš„ç®¡ç†
<a class=heading-link href=#oauth-20-client-%e5%af%b9-access-token-%e7%9a%84%e7%ae%a1%e7%90%86><i class="fa-solid fa-link" aria-hidden=true title=é“¾æ¥åˆ°æ ‡é¢˜></i>
<span class=sr-only>é“¾æ¥åˆ°æ ‡é¢˜</span></a></h3><p>OAuth 2.0 Client ä¸»è¦è¡¨ 1 ä¸­çš„æ¥å£æ¥å¯¹ Access Token è¿›è¡Œç®¡ç†ã€‚å¯¹ä¸è¿™äº›æ¥å£æˆ–å®ç°ç±»çš„è¯¦ç»†è¯´æ˜å¯ä»¥å‚è€ƒå®˜æ–¹<a href=https://docs.spring.io/spring-security/reference/servlet/oauth2/client/core.html class=external-link target=_blank rel=noopener>Core Interfaces and Classes</a></p><table><thead><tr><th>æ¥å£</th><th>è¯´æ˜</th><th>å®ç°ç±»ä¸¾ä¾‹</th></tr></thead><tbody><tr><td>OAuth2AuthorizedClientManager</td><td>ç”¨æ¥ç®¡ç†è·å– Access Token çš„æ•´ä¸ªæµç¨‹ã€‚é€šè¿‡ OAuth2AuthorizedClientProvider è·å– Access Tokenã€‚é€šè¿‡ OAuth2AuthorizedClientRepository ç¼“å­˜æˆ–æŒä¹…åŒ– Access Tokenã€‚å”¯ä¸€çš„æ–¹æ³•ä¸º authorizeï¼Œç”¨æ¥è·å–æˆæƒã€‚</td><td>DefaultOAuth2AuthorizedClientManagerï¼Œç”¨äº HttpServletRequest ä¸Šä¸‹æ–‡ä¸­çš„é»˜è®¤ OAuth2AuthorizedClientManager å®ç°ã€‚ AuthorizedClientServiceOAuth2AuthorizedClientManager ä¸€ä¸ª OAuth2AuthorizedClientManager çš„å®ç°ï¼Œèƒ½å¤Ÿåœ¨ HttpServletRequest çš„ä¸Šä¸‹æ–‡ä¹‹å¤–è¿è¡Œï¼Œä¾‹å¦‚åœ¨è®¡åˆ’ä»»åŠ¡/åå°çº¿ç¨‹ä¸­å’Œ/æˆ–åœ¨æœåŠ¡å±‚ä¸­ã€‚</td></tr><tr><td>OAuth2AuthorizedClientRepository</td><td>ç”¨æ¥ç¼“å­˜ Access Tokenã€‚ loadAuthorizedClient æ–¹æ³•ç”¨æ¥ä»ç¼“å­˜ä¸­è·å– Access Tokenï¼›saveAuthorizedClient æ–¹æ³•ç”¨æˆ·åœ¨å¾—åˆ°æ–°çš„ Access Token ä¹‹åï¼Œå°†å…¶ç¼“å­˜æˆ–æŒä¹…åŒ–ï¼›removeAuthorizedClient æ–¹æ³•ç”¨æ¥ç§»é™¤ç¼“å­˜ä¸­çš„ Access Tokenã€‚</td><td>HttpSessionOAuth2AuthorizedClientRepositoryï¼Œç”¨äºå°† Access Token ç¼“å­˜åœ¨ HttpSession ä¼šè¯ä¸­ã€‚</td></tr><tr><td>OAuth2AuthorizedClientProvider</td><td>ç”¨æ¥è·å– Access Tokenã€‚ authorize æ–¹æ³•å…ˆä»å…¥å‚ä¸­è·å– Access Tokenï¼Œå¦‚æœæ²¡æœ‰è¿‡æœŸï¼Œåˆ™è¿”å›è¯¥ Access Tokenï¼›å¦‚æœè¿‡æœŸï¼Œåˆ™é‡æ–°ä» Authorization Server è·å–æ–°çš„ Access Tokenã€‚</td><td>ClientCredentialsOAuth2AuthorizedClientProviderï¼Œç”¨äºä»¥å®¢æˆ·ç«¯æ¨¡å¼çš„æ–¹å¼ä» Authorization Server ä¸­è·å– Access Tokenï¼ˆå¦‚æœç¼“å­˜ä¸­ Access Token ä»¥åŠè¿‡æœŸçš„æƒ…å†µä¸‹ï¼‰ã€‚</td></tr><tr><td>OAuth2AuthorizationSuccessHandler</td><td>ä» Authorization Server æˆåŠŸè·å– Access Token ï¼ˆæˆæƒæˆåŠŸï¼‰ä¹‹åçš„å¤„ç†å™¨ã€‚æ¯”å¦‚å°† Access Token ç¼“å­˜åˆ° OAuth2AuthorizedClientRepository ä¸­æˆ–å…¶ä»–åç»­æ“ä½œã€‚</td><td></td></tr><tr><td>OAuth2AuthorizedClient</td><td>ä»£è¡¨ä¸€ä¸ª OAuth 2.0 &ldquo;Authorized Client&rdquo;ã€‚é€šå¸¸å…¶ä¸­åŒ…å« Client ä¿¡æ¯å’Œåç»­è·å–åˆ°çš„ Access Tokenã€‚</td><td></td></tr><tr><td>OAuth2AuthorizationFailureHandler</td><td>ç”¨æ¥å¤„ç†æˆæƒå¤±è´¥ä¹‹åçš„å¤„ç†å™¨ã€‚æ¯”å¦‚ä» Access Token ä» OAuth2AuthorizedClientRepository ä¸­æˆ–å…¶ä»–åç»­æ“ä½œã€‚</td><td></td></tr></tbody></table><p>è¡¨ 1 OAuth 2.0 Client çš„ä¸»è¦æ¥å£</p><p>ä¸‹é¢ä»¥å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆclient credentials grantï¼‰æˆæƒæ¨¡å¼ä¸‹çš„ OAuth 2.0 Client ä¸ºä¾‹ï¼Œæ¥å…·ä½“è¯´æ˜ Access Token çš„æ•´ä¸ªç®¡ç†è¿‡ç¨‹ã€‚é€šè¿‡ OAuth 2.0 Client ä»¥å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆclient credentials grantï¼‰æˆæƒæ¨¡å¼è·å– Access Token æ—¶ï¼Œé€šå¸¸æœ‰ä¸¤ç§ä½¿ç”¨åœºæ™¯ã€‚ç¬¬ä¸€ç§çš„ Access Token çš„ scope æ˜¯ç”¨æˆ·ï¼Œæ¯ä¸€ä¸ªç”¨æˆ·ä¸€ä¸ª Access Tokenã€‚ç¬¬äºŒç§çš„ Access Token çš„ scope æ˜¯åº”ç”¨ï¼Œæ¯ä¸€ä¸ªåº”ç”¨ä¸€ä¸ª Access Tokenã€‚è¿™ä¸¤ç§çš„ä½¿ç”¨åœºæ™¯å¦‚å›¾ 3 æ‰€ç¤ºã€‚</p><p><img src=/spring-boot/How-to-use-OAuth-2-Client-in-Spring-Boot/Obtain-access-token-per-user-vs-per-application.svg alt="ä¸€ä¸ªç”¨æˆ·ä¸€ä¸ª Access Token VS ä¸€ä¸ªç”¨æˆ·ä¸€ä¸ª Access Token">
å›¾ 3 ä¸€ä¸ªç”¨æˆ·ä¸€ä¸ª Access Token VS ä¸€ä¸ªç”¨æˆ·ä¸€ä¸ª Access Token</p><p>åœ¨ Spring Security OAuth2 client ä¸­é€šè¿‡ä¸åŒçš„ OAuth2AuthorizedClientManager å®ç°ç±»æ¥å®Œæˆç›¸åº”çš„å·¥ä½œã€‚ç¬¬ä¸€ç§æ˜¯é€šè¿‡ DefaultOAuth2AuthorizedClientManagerï¼Œå…¶å·¥ä½œåŸç†æ—¶åºå›¾å¦‚å›¾4 æ‰€ç¤ºã€‚ç¬¬äºŒç§æ˜¯é€šè¿‡ AuthorizedClientServiceOAuth2AuthorizedClientManagerï¼Œå…¶å·¥ä½œåŸç†æ—¶åºå›¾å¦‚å›¾ 5 æ‰€ç¤ºã€‚</p><p>ä¸‹é¢ä»¥ç¬¬ä¸€ç§ä¸ºç¤ºä¾‹ï¼Œæ¥è¯¦ç»†è¯´æ˜å…¶è¿‡ç¨‹ã€‚</p><ol><li>æˆ‘ä»¬çš„ç»„ä»¶é€šè¿‡ DefaultOAuth2AuthorizedClientManagerï¼ˆOAuth2AuthorizedClientManagerï¼‰ çš„ authorize æ–¹æ³•æ¥å°è¯•è·å–æˆæƒã€‚</li><li>DefaultOAuth2AuthorizedClientManagerï¼ˆOAuth2AuthorizedClientManagerï¼‰å°è¯•é€šè¿‡ HttpSessionOAuth2AuthorizedClientRepositoryï¼ˆOAuth2AuthorizedClientRepositoryï¼‰çš„ loadAuthorizedClient æ–¹æ³•ï¼Œä»ç¼“å­˜ï¼ˆHttpSessionï¼‰ä¸­è·å– OAuth2AuthorizedClient å¯¹è±¡ï¼ˆå¦‚æœç¼“å­˜ä¸­æœ‰ Access Token, é‚£ä¹ˆè¯¥å¯¹è±¡ä¸­å°±ä¼šåŒ…å«æ—§çš„ Access Tokenï¼‰ã€‚</li><li>DefaultOAuth2AuthorizedClientManagerï¼ˆOAuth2AuthorizedClientManagerï¼‰é€šè¿‡ ClientCredentialsOAuth2AuthorizedClientProviderï¼ˆOAuth2AuthorizedClientProviderï¼‰çš„ authorize æ–¹æ³•ï¼Œåˆ¤æ–­ Access Token æ˜¯å¦è¿‡æœŸã€‚å¦‚ä½•æ²¡æœ‰è¿‡æœŸï¼Œåˆ™è¿”å›æºå¸¦æ—§ Access Token çš„ OAuth2AuthorizedClient å¯¹è±¡ï¼›å¦‚æœä»¥åŠè¿‡æœŸï¼Œåˆ™ä» Authorization Server ä¸­é‡æ–°è·å–æ–°çš„ Access Tokenã€‚</li><li>å¦‚æœæˆæƒå¤±è´¥ï¼ŒDefaultOAuth2AuthorizedClientManagerï¼ˆOAuth2AuthorizedClientManagerï¼‰é€šè¿‡ OAuth2AuthorizationFailureHandler ç§»é™¤ HttpSessionOAuth2AuthorizedClientRepositoryï¼ˆOAuth2AuthorizedClientRepositoryï¼‰ä¸­ç¼“å­˜çš„ Access Tokenã€‚</li><li>å¦‚æœæˆæƒæˆåŠŸï¼ŒDefaultOAuth2AuthorizedClientManagerï¼ˆOAuth2AuthorizedClientManagerï¼‰é€šè¿‡ OAuth2AuthorizationSuccessHandler å°†æ–°çš„ Access Token é‡æ–°ç¼“å­˜åˆ° HttpSessionOAuth2AuthorizedClientRepositoryï¼ˆOAuth2AuthorizedClientRepositoryï¼‰ä¸­ã€‚</li></ol><p><img src=/spring-boot/How-to-use-OAuth-2-Client-in-Spring-Boot/how-OAuth2AuthorizedClientManager-manage-access-token.png alt="å¯¹äºæ¯ä¸€ä¸ªç”¨æˆ·ä¸€ä¸ª Access Token çš„æƒ…å†µï¼ŒOAuth 2.0 Client é€šè¿‡ DefaultOAuth2AuthorizedClientManager ç®¡ç† Access Token çš„æ—¶åºå›¾"></p><p>å›¾ 4 å¯¹äºæ¯ä¸€ä¸ªç”¨æˆ·ä¸€ä¸ª Access Token çš„æƒ…å†µï¼ŒOAuth 2.0 Client é€šè¿‡ DefaultOAuth2AuthorizedClientManager ç®¡ç† Access Token çš„æ—¶åºå›¾</p><p><img src=/spring-boot/How-to-use-OAuth-2-Client-in-Spring-Boot/how-AuthorizedClientServiceOAuth2AuthorizedClientManager-works.png alt="å¯¹äºæ¯ä¸€ä¸ªåº”ç”¨ä¸€ä¸ª Access Token çš„æƒ…å†µï¼ŒOAuth 2.0 Client é€šè¿‡ AuthorizedClientServiceOAuth2AuthorizedClientManager ç®¡ç† Access Token çš„æ—¶åºå›¾"></p><p>å›¾ 5 å¯¹äºæ¯ä¸€ä¸ªåº”ç”¨ä¸€ä¸ª Access Token çš„æƒ…å†µï¼ŒOAuth 2.0 Client é€šè¿‡ AuthorizedClientServiceOAuth2AuthorizedClientManager ç®¡ç† Access Token çš„æ—¶åºå›¾</p><p>å¯¹äºèƒŒæ™¯ä¸­æè¿°çš„åœºæ™¯ï¼Œæˆ‘ä»¬ç¬¦åˆç¬¬äºŒç§ï¼ˆæ¯ä¸€ä¸ªåº”ç”¨ä¸€ä¸ª Access Tokenï¼‰ã€‚</p><h2 id=oauth-20-client-çš„ä½¿ç”¨>OAuth 2.0 Client çš„ä½¿ç”¨
<a class=heading-link href=#oauth-20-client-%e7%9a%84%e4%bd%bf%e7%94%a8><i class="fa-solid fa-link" aria-hidden=true title=é“¾æ¥åˆ°æ ‡é¢˜></i>
<span class=sr-only>é“¾æ¥åˆ°æ ‡é¢˜</span></a></h2><p>ä¸‹é¢ä»¥å®¢æˆ·ç«¯æˆæƒæ¨¡å¼ä¸º client_credentials__grant å¹¶ä¸”å®¢æˆ·ç«¯è®¤è¯æ–¹å¼ä¸º client_secret_post çš„æƒ…å†µä¸ºä¾‹ï¼Œæ¥è¯´æ˜å¦‚ä½•ä½¿ç”¨ OAuth 2.0 Clientã€‚ä½¿ç”¨ OAuth 2.0 Client æ—¶ï¼Œéœ€è¦åœ¨ application.yaml ä¸­é…ç½® client ä¿¡æ¯å’ŒæŒ‡å®š OAuth2AuthorizedClientProvider é‡‡ç”¨çš„å®¢æˆ·ç«¯æˆæƒæ¨¡å¼ã€‚</p><h3 id=å¼•å…¥ä¾èµ–>å¼•å…¥ä¾èµ–
<a class=heading-link href=#%e5%bc%95%e5%85%a5%e4%be%9d%e8%b5%96><i class="fa-solid fa-link" aria-hidden=true title=é“¾æ¥åˆ°æ ‡é¢˜></i>
<span class=sr-only>é“¾æ¥åˆ°æ ‡é¢˜</span></a></h3><p>å¦‚ä»£ç æ¸…å• 1 æ‰€ç¤ºï¼Œé™¤äº†å…¶ä»–ä¾èµ–å¤–æˆ‘ä»¬é‡ç‚¹è¦å¼•å…¥ <code>spring-security-oauth2-client</code> ä¾èµ–é¡¹ã€‚</p><p>ä»£ç æ¸…å• 1ï¼šå¼•å…¥ä¾èµ– pom.xml</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#7ee787>&lt;dependencies&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-web --&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#7ee787>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;artifactId&gt;</span>spring-boot-starter-web<span style=color:#7ee787>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#7ee787>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;artifactId&gt;</span>spring-boot-starter-security<span style=color:#7ee787>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>&lt;!-- https://mvnrepository.com/artifact/org.springframework.security/spring-security-oauth2-client --&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;groupId&gt;</span>org.springframework.security<span style=color:#7ee787>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;artifactId&gt;</span>spring-security-oauth2-client<span style=color:#7ee787>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>&lt;!-- https://mvnrepository.com/artifact/com.squareup.okhttp3/mockwebserver --&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;groupId&gt;</span>com.squareup.okhttp3<span style=color:#7ee787>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;artifactId&gt;</span>mockwebserver<span style=color:#7ee787>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;version&gt;</span>4.12.0<span style=color:#7ee787>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;scope&gt;</span>test<span style=color:#7ee787>&lt;/scope&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#7ee787>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;artifactId&gt;</span>spring-boot-starter-test<span style=color:#7ee787>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#7ee787>&lt;/dependencies&gt;</span>
</span></span></code></pre></div><h3 id=é…ç½®-applicationyaml-ä¸­é…ç½®-client-ä¿¡æ¯>é…ç½® application.yaml ä¸­é…ç½® client ä¿¡æ¯
<a class=heading-link href=#%e9%85%8d%e7%bd%ae-applicationyaml-%e4%b8%ad%e9%85%8d%e7%bd%ae-client-%e4%bf%a1%e6%81%af><i class="fa-solid fa-link" aria-hidden=true title=é“¾æ¥åˆ°æ ‡é¢˜></i>
<span class=sr-only>é“¾æ¥åˆ°æ ‡é¢˜</span></a></h3><p>å¦‚ä»£ç æ¸…å• 2 æ‰€ç¤ºï¼Œåœ¨ application.yaml ä¸­éœ€è¦é…ç½® registration å’Œ providerã€‚</p><ul><li>registration<ul><li>registration ä¸­æ³¨å†Œä¸€ä¸ªåä¸º <code>some-client</code> çš„ clientã€‚<ul><li>provider: è¯¥ client ä¸‹é¢åŒ…å«äº† <code>provider</code> éœ€è¦ä¸ <code>spring.security.oauth2.client.provider</code> ä¸‹çš„æŸä¸ª provider ä¸€è‡´ã€‚å¦‚ä»£ç æ¸…å• 2 ä¸­çš„ <code>spring.security.oauth2.client.registration.some-client.provider</code> çš„å€¼ä¸ <code>spring.security.oauth2.client.provider.some-provider</code> ä¸€è‡´ã€‚</li><li>client-id: client çš„ id</li><li>client-secret: client secret</li><li>authorization-grant-type: ç”¨æ¥è¡¨ç¤ºå®¢æˆ·ç«¯æˆæƒçš„æ¨¡å¼ã€‚å¯é€‰æ‹©å€¼æœ‰ authorization_code_grant,client_credentials__grant,implicit_grant,resource_owner_password_credentials_grantã€‚</li><li>client-authentication-methodï¼šç”¨æ¥è¡¨ç¤ºè®¤è¯çš„æ–¹å¼ã€‚å¯é€‰å€¼æœ‰ client_secret_basicï¼Œclient_secret_postï¼Œclient_secret_jwtï¼Œprivate_key_jwtï¼Œtls_client_authï¼Œself_signed_tls_client_authã€‚</li></ul></li></ul></li><li>provider<ul><li>some-provider: provider çš„åå­—ã€‚å¯ä»¥è‡ªå®šä¹‰ã€‚</li><li>token-uri: è·å–æˆæƒçš„åœ°å€ã€‚</li></ul></li></ul><p>ä»£ç æ¸…å• 2ï¼šOauth 2.0 Client çš„é…ç½® application.yaml</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>spring</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>security</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>oauth2</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>client</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>registration</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>some-client</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>provider</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>some-provider</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>client-id</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>custom-client-id</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>client-secret</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>custom-client-secret</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>authorization-grant-type</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>client_credentials</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>client-authentication-method</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>client_secret_post</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>scope</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span>- <span style=color:#a5d6ff>&#34;read&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>provider</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>some-provider</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#7ee787>token-uri</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>http://localhost:9000/oauth2/token</span><span style=color:#6e7681>
</span></span></span></code></pre></div><h3 id=æŒ‡å®š-oauth2authorizedclientprovider-çš„æˆæƒæ¨¡å¼>æŒ‡å®š OAuth2AuthorizedClientProvider çš„æˆæƒæ¨¡å¼
<a class=heading-link href=#%e6%8c%87%e5%ae%9a-oauth2authorizedclientprovider-%e7%9a%84%e6%8e%88%e6%9d%83%e6%a8%a1%e5%bc%8f><i class="fa-solid fa-link" aria-hidden=true title=é“¾æ¥åˆ°æ ‡é¢˜></i>
<span class=sr-only>é“¾æ¥åˆ°æ ‡é¢˜</span></a></h3><p>å¦‚ä»£ç æ¸…å• 3 æ‰€ç¤ºï¼Œé…ç½®å’ŒæŒ‡å®š OAuth2AuthorizedClientProvider çš„å®¢æˆ·ç«¯æˆæƒæ¨¡å¼ã€‚</p><p>ä»£ç æ¸…å• 3ï¼šç”¨æ¥æŒ‡å®š OAuth2AuthorizedClientProvider çš„å®¢æˆ·ç«¯æˆæƒæ¨¡å¼ Oauth2ClientConfig.java</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>package</span><span style=color:#6e7681> </span><span style=color:#ff7b72>com.mervyn.springboot.learn.config</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.context.annotation.Bean</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.context.annotation.Configuration</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.security.oauth2.client.AuthorizedClientServiceOAuth2AuthorizedClientManager</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.security.oauth2.client.OAuth2AuthorizedClientManager</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.security.oauth2.client.OAuth2AuthorizedClientProvider</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.security.oauth2.client.OAuth2AuthorizedClientProviderBuilder</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.security.oauth2.client.OAuth2AuthorizedClientService</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.security.oauth2.client.registration.ClientRegistrationRepository</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.security.oauth2.client.web.client.OAuth2ClientHttpRequestInterceptor</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.web.client.RestClient</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#d2a8ff;font-weight:700>@Configuration</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>RestClientConfig</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#d2a8ff;font-weight:700>@Bean</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span>OAuth2AuthorizedClientManager<span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>authorizedClientManager</span>(<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span>ClientRegistrationRepository<span style=color:#6e7681> </span>clientRegistrationRepository,<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span>OAuth2AuthorizedClientService<span style=color:#6e7681> </span>OAuth2AuthorizedClientService)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>OAuth2AuthorizedClientProvider<span style=color:#6e7681> </span>authorizedClientProvider<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>OAuth2AuthorizedClientProviderBuilder.builder()<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                    </span>.clientCredentials()<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                    </span>.build();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>AuthorizedClientServiceOAuth2AuthorizedClientManager<span style=color:#6e7681> </span>authorizedClientManager<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#ff7b72>new</span><span style=color:#6e7681> </span>AuthorizedClientServiceOAuth2AuthorizedClientManager(clientRegistrationRepository,<span style=color:#6e7681> </span>OAuth2AuthorizedClientService);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>authorizedClientManager.setAuthorizedClientProvider(authorizedClientProvider);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>return</span><span style=color:#6e7681> </span>authorizedClientManager;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#d2a8ff;font-weight:700>@Bean</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span>RestClient<span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>restClient</span>(OAuth2AuthorizedClientManager<span style=color:#6e7681> </span>authorizedClientManager)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>OAuth2ClientHttpRequestInterceptor<span style=color:#6e7681> </span>requestInterceptor<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#ff7b72>new</span><span style=color:#6e7681> </span>OAuth2ClientHttpRequestInterceptor(authorizedClientManager);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>return</span><span style=color:#6e7681> </span>RestClient.builder().requestInterceptor(requestInterceptor).build();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>}<span style=color:#6e7681>
</span></span></span></code></pre></div><h3 id=æµ‹è¯•>æµ‹è¯•
<a class=heading-link href=#%e6%b5%8b%e8%af%95><i class="fa-solid fa-link" aria-hidden=true title=é“¾æ¥åˆ°æ ‡é¢˜></i>
<span class=sr-only>é“¾æ¥åˆ°æ ‡é¢˜</span></a></h3><p>ä¸ºäº†æµ‹è¯•æ˜¯å¦èƒ½ä» Authorization Server è·å–åˆ° Access Tokenã€‚é€šè¿‡ <code>/token-test</code>æ¥å£æš´éœ² Access Token çš„å€¼ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬é€šè¿‡ MockMvc æ¥æµ‹è¯•è¯¥æ¥å£çš„è¿”å›å€¼ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬é€šè¿‡ MockWebServer æ¥æ¨¡æ‹Ÿ Authorization Server çš„è¡Œä¸ºï¼Œå¹¶ä¸”é€šè¿‡ takeRequest æ–¹æ³•è·å– OAuth2AuthorizedClientProvider å‘é€çš„è¯·æ±‚æ˜¯å¦ç¬¦åˆæœŸæœ›ã€‚
ä»£ç æ¸…å• 4: å¯¹è·å– Access Token çš„æ¥å£è¿›è¡Œé›†æˆæµ‹è¯• AuthorizationClientTest.java</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>package</span><span style=color:#6e7681> </span><span style=color:#ff7b72>com.mervyn.springboot.learn</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>com.fasterxml.jackson.core.JsonProcessingException</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>com.fasterxml.jackson.databind.json.JsonMapper</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>okhttp3.mockwebserver.Dispatcher</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>okhttp3.mockwebserver.MockResponse</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>okhttp3.mockwebserver.MockWebServer</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>okhttp3.mockwebserver.RecordedRequest</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.hamcrest.core.Is</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.junit.jupiter.api.AfterAll</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.junit.jupiter.api.AfterEach</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.junit.jupiter.api.BeforeAll</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.junit.jupiter.api.Test</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.beans.factory.annotation.Autowired</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.boot.test.context.SpringBootTest</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.http.MediaType</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.security.oauth2.client.OAuth2AuthorizedClientService</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.test.web.servlet.MockMvc</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.test.web.servlet.MvcResult</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.test.web.servlet.request.MockMvcRequestBuilders</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>java.io.IOException</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>java.util.HashMap</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>java.util.Map</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>java.util.UUID</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>java.util.concurrent.TimeUnit</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.hamcrest.CoreMatchers.equalTo</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.hamcrest.MatcherAssert.assertThat</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.hamcrest.Matchers.containsString</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.hamcrest.Matchers.not</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.hamcrest.Matchers.notNullValue</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.hamcrest.Matchers.nullValue</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.test.web.servlet.result.MockMvcResultMatchers.content</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.springframework.test.web.servlet.result.MockMvcResultMatchers.status</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#d2a8ff;font-weight:700>@SpringBootTest</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#d2a8ff;font-weight:700>@AutoConfigureMockMvc</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>AuthorizationClientTest</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span><span style=color:#ff7b72>static</span><span style=color:#6e7681> </span>MockWebServer<span style=color:#6e7681> </span>server;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#d2a8ff;font-weight:700>@Autowired</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span>MockMvc<span style=color:#6e7681> </span>mockMvc;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#d2a8ff;font-weight:700>@Autowired</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>private</span><span style=color:#6e7681>  </span>OAuth2AuthorizedClientService<span style=color:#6e7681> </span>authorizedClientService;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#d2a8ff;font-weight:700>@BeforeAll</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>setup</span>()<span style=color:#6e7681> </span><span style=color:#ff7b72>throws</span><span style=color:#6e7681> </span>IOException<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>server<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#ff7b72>new</span><span style=color:#6e7681> </span>MockWebServer();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>final</span><span style=color:#6e7681> </span>Dispatcher<span style=color:#6e7681> </span>dispatcher<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#ff7b72>new</span><span style=color:#6e7681> </span>Dispatcher()<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#d2a8ff;font-weight:700>@Override</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span>MockResponse<span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>dispatch</span>(RecordedRequest<span style=color:#6e7681> </span>request)<span style=color:#6e7681> </span><span style=color:#ff7b72>throws</span><span style=color:#6e7681> </span>InterruptedException<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>switch</span><span style=color:#6e7681> </span>(request.getPath())<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#ff7b72>case</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;/oauth2/token&#34;</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>Map<span style=color:#ff7b72;font-weight:700>&lt;</span>String,<span style=color:#6e7681> </span>String<span style=color:#ff7b72;font-weight:700>&gt;</span><span style=color:#6e7681> </span>responseMap<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#ff7b72>new</span><span style=color:#6e7681> </span>HashMap<span style=color:#ff7b72;font-weight:700>&lt;&gt;</span>();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>responseMap.put(<span style=color:#a5d6ff>&#34;access_token&#34;</span>,<span style=color:#6e7681> </span>UUID.randomUUID().toString());<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>responseMap.put(<span style=color:#a5d6ff>&#34;scope&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;read&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>responseMap.put(<span style=color:#a5d6ff>&#34;token_type&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;Bearer&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>responseMap.put(<span style=color:#a5d6ff>&#34;expires_in&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;120&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>JsonMapper<span style=color:#6e7681> </span>jsonMapper<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#ff7b72>new</span><span style=color:#6e7681> </span>JsonMapper();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>String<span style=color:#6e7681> </span>response<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>buildJsonResponse(jsonMapper,<span style=color:#6e7681> </span>responseMap);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#ff7b72>return</span><span style=color:#6e7681> </span><span style=color:#ff7b72>new</span><span style=color:#6e7681> </span>MockResponse()<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                    </span>.addHeader(<span style=color:#a5d6ff>&#34;Content-Type&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;application/json; charset=utf-8&#34;</span>)<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                    </span>.setResponseCode(200)<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                    </span>.setBody(response);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>return</span><span style=color:#6e7681> </span><span style=color:#ff7b72>new</span><span style=color:#6e7681> </span>MockResponse().setResponseCode(404);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>};<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>server.setDispatcher(dispatcher);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>server.start(9000);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span><span style=color:#ff7b72>static</span><span style=color:#6e7681> </span>String<span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>buildJsonResponse</span>(JsonMapper<span style=color:#6e7681> </span>jsonMapper,<span style=color:#6e7681> </span>Map<span style=color:#ff7b72;font-weight:700>&lt;</span>String,<span style=color:#6e7681> </span>String<span style=color:#ff7b72;font-weight:700>&gt;</span><span style=color:#6e7681> </span>responseMap)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>String<span style=color:#6e7681> </span>response<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#79c0ff>null</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>try</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>response<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>jsonMapper.writeValueAsString(responseMap);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681> </span><span style=color:#ff7b72>catch</span><span style=color:#6e7681> </span>(JsonProcessingException<span style=color:#6e7681> </span>e)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>return</span><span style=color:#6e7681> </span>response;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#d2a8ff;font-weight:700>@Test</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>shouldReturnAccessTokenWhenRetrieveAccessToken</span>()<span style=color:#6e7681> </span><span style=color:#ff7b72>throws</span><span style=color:#6e7681> </span>Exception<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>mockMvc.perform(MockMvcRequestBuilders.get(<span style=color:#a5d6ff>&#34;/token-test&#34;</span>))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andExpect(status().isOk())<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andExpect(content().string(notNullValue()))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andExpect(content().string(not(<span style=color:#a5d6ff>&#34;&#34;</span>)));<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>RecordedRequest<span style=color:#6e7681> </span>request<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>server.takeRequest();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>assertThat(request.getHeaders().get(<span style=color:#a5d6ff>&#34;Content-Type&#34;</span>),<span style=color:#6e7681> </span>containsString(MediaType.APPLICATION_FORM_URLENCODED_VALUE));<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>String<span style=color:#6e7681> </span>bodyContent<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>request.getBody().readUtf8();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>assertThat(bodyContent,<span style=color:#6e7681> </span>containsString(<span style=color:#a5d6ff>&#34;client_id=custom-client-id&#34;</span>));<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>assertThat(bodyContent,<span style=color:#6e7681> </span>containsString(<span style=color:#a5d6ff>&#34;client_secret=custom-client-secret&#34;</span>));<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>assertThat(bodyContent,<span style=color:#6e7681> </span>containsString(<span style=color:#a5d6ff>&#34;grant_type=client_credentials&#34;</span>));<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>assertThat(bodyContent,<span style=color:#6e7681> </span>containsString(<span style=color:#a5d6ff>&#34;scope=read&#34;</span>));<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#d2a8ff;font-weight:700>@Test</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>shouldReturnSameAccessTokenAndCallAuthorizationServerOnlyOnceWhenAccessTokenIsNotExpired</span>()<span style=color:#6e7681> </span><span style=color:#ff7b72>throws</span><span style=color:#6e7681> </span>Exception<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>MvcResult<span style=color:#6e7681> </span>mvcResult1<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>mockMvc.perform(MockMvcRequestBuilders.get(<span style=color:#a5d6ff>&#34;/token-test&#34;</span>))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andExpect(status().isOk())<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andExpect(content().string(notNullValue()))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andExpect(content().string(not(<span style=color:#a5d6ff>&#34;&#34;</span>)))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andReturn();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>MvcResult<span style=color:#6e7681> </span>mvcResult2<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>mockMvc.perform(MockMvcRequestBuilders.get(<span style=color:#a5d6ff>&#34;/token-test&#34;</span>))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andExpect(status().isOk())<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andExpect(content().string(notNullValue()))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andExpect(content().string(not(<span style=color:#a5d6ff>&#34;&#34;</span>)))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andReturn();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>String<span style=color:#6e7681> </span>response1<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>mvcResult1.getResponse().getContentAsString();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>String<span style=color:#6e7681> </span>response2<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>mvcResult2.getResponse().getContentAsString();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>assertThat(response1,<span style=color:#6e7681> </span>Is.is(response2));<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>RecordedRequest<span style=color:#6e7681> </span>request<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>server.takeRequest(3,<span style=color:#6e7681> </span>TimeUnit.MILLISECONDS);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>assertThat(request,<span style=color:#6e7681> </span>notNullValue());<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>RecordedRequest<span style=color:#6e7681> </span>request1<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>server.takeRequest(3,<span style=color:#6e7681> </span>TimeUnit.MILLISECONDS);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>assertThat(request1,<span style=color:#6e7681> </span>nullValue());<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#d2a8ff;font-weight:700>@Test</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>shouldReturnDifferentAccessTokenCallAuthorizationServerTwiceWhenAccessTokenIsExpired</span>()<span style=color:#6e7681> </span><span style=color:#ff7b72>throws</span><span style=color:#6e7681> </span>Exception<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>MvcResult<span style=color:#6e7681> </span>mvcResult1<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>mockMvc.perform(MockMvcRequestBuilders.get(<span style=color:#a5d6ff>&#34;/token-test&#34;</span>))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andExpect(status().isOk())<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andExpect(content().string(notNullValue()))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andExpect(content().string(not(<span style=color:#a5d6ff>&#34;&#34;</span>)))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andReturn();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>RecordedRequest<span style=color:#6e7681> </span>request<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>server.takeRequest(3,<span style=color:#6e7681> </span>TimeUnit.MILLISECONDS);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>assertThat(request,<span style=color:#6e7681> </span>notNullValue());<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>TimeUnit.SECONDS.sleep(140);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>MvcResult<span style=color:#6e7681> </span>mvcResult2<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>mockMvc.perform(MockMvcRequestBuilders.get(<span style=color:#a5d6ff>&#34;/token-test&#34;</span>))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andExpect(status().isOk())<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andExpect(content().string(notNullValue()))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andExpect(content().string(not(<span style=color:#a5d6ff>&#34;&#34;</span>)))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.andReturn();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>RecordedRequest<span style=color:#6e7681> </span>request1<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>server.takeRequest(3,<span style=color:#6e7681> </span>TimeUnit.MILLISECONDS);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>assertThat(request1,<span style=color:#6e7681> </span>notNullValue());<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>String<span style=color:#6e7681> </span>response1<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>mvcResult1.getResponse().getContentAsString();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>String<span style=color:#6e7681> </span>response2<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>mvcResult2.getResponse().getContentAsString();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>assertThat(response1,<span style=color:#6e7681> </span>not(equalTo(response2)));<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#d2a8ff;font-weight:700>@AfterEach</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>removeAccessTokenFromCache</span>()<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>authorizedClientService.removeAuthorizedClient(<span style=color:#a5d6ff>&#34;some-client&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;test&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#d2a8ff;font-weight:700>@AfterAll</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>teardown</span>()<span style=color:#6e7681> </span><span style=color:#ff7b72>throws</span><span style=color:#6e7681> </span>IOException<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>server.shutdown();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>}<span style=color:#6e7681>
</span></span></span></code></pre></div></div><div style="text-align:center;color:#a9a9a9;width:50%;margin:0 auto"><p>æœ¬ä½œå“é‡‡ç”¨<a href=http://creativecommons.org/licenses/by-nc-nd/4.0/ style=color:#a9a9a9>çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç¦æ­¢æ¼”ç» 4.0 å›½é™…è®¸å¯åè®®</a>è¿›è¡Œè®¸å¯</p></div><div style="border-bottom-style:dashed;border-bottom-style:inset;border-bottom-width:2px;width:50%;margin:0 auto"></div><footer><div class=comments><script>let getTheme=window.localStorage&&window.localStorage.getItem("colorscheme");getTheme=getTheme??"light";let s=document.createElement("script");s.src="https://giscus.app/client.js",s.setAttribute("data-repo","csmervyn/csmervyn.github.io"),s.setAttribute("data-repo-id","R_kgDOGbYn4A"),s.setAttribute("data-category","Announcements"),s.setAttribute("data-category-id","DIC_kwDOGbYn4M4CWQYR"),s.setAttribute("data-mapping","pathname"),s.setAttribute("data-term",""),s.setAttribute("data-strict","0"),s.setAttribute("data-reactions-enabled","1"),s.setAttribute("data-emit-metadata","0"),s.setAttribute("data-input-position","bottom"),s.setAttribute("data-theme",getTheme),s.setAttribute("data-lang","zh-CN"),s.setAttribute("data-loading",""),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.comments").innerHTML="",document.querySelector("div.comments").appendChild(s)</script></div></footer></article></section></div><footer class=footer><section class=container>Â©
2019 -
2025
Mervyn
Â·
æŠ€æœ¯æ”¯æŒ <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>