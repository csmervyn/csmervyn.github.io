<!doctype html><html lang=zh-cn><head><title>ç¬¬å…«ç«  åè®®å‡çº§å’Œéé˜»å¡ IOã€éƒ¨åˆ†ã€‘ Â· å¢¨å®¢äººç”Ÿ
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Mervyn"><meta name=description content="Servlet æ‰€æä¾›çš„éé˜»å¡ IO ä»…å¯ä»¥åœ¨ Servlet å¼‚æ­¥å¤„ç†å’Œåè®®å‡çº§ä¸­ä½¿ç”¨ã€‚æˆ‘ä»¬åœ¨ç¬¬ä¸ƒç« å·²ç»è¯¦ç»†é˜è¿°äº† Servlet å¼‚æ­¥å¤„ç†ï¼Œå› æ­¤æœ¬ç« é¦–å…ˆç®€å•é˜è¿° Servlet å¯¹åè®®å‡çº§çš„æ”¯æŒï¼Œç„¶åé‡ç‚¹é˜è¿° Servlet ä¸ºæ”¯æŒéé˜»å¡ IO æ‰€æä¾›çš„ç›¸å…³ API ä»¥åŠé€šè¿‡ç¤ºä¾‹æ¥è¯´æ˜å®ƒä»¬çš„ä½¿ç”¨åœºæ™¯å’Œç”¨æ³•ã€‚"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="ç¬¬å…«ç«  åè®®å‡çº§å’Œéé˜»å¡ IOã€éƒ¨åˆ†ã€‘"><meta name=twitter:description content="Servlet æ‰€æä¾›çš„éé˜»å¡ IO ä»…å¯ä»¥åœ¨ Servlet å¼‚æ­¥å¤„ç†å’Œåè®®å‡çº§ä¸­ä½¿ç”¨ã€‚æˆ‘ä»¬åœ¨ç¬¬ä¸ƒç« å·²ç»è¯¦ç»†é˜è¿°äº† Servlet å¼‚æ­¥å¤„ç†ï¼Œå› æ­¤æœ¬ç« é¦–å…ˆç®€å•é˜è¿° Servlet å¯¹åè®®å‡çº§çš„æ”¯æŒï¼Œç„¶åé‡ç‚¹é˜è¿° Servlet ä¸ºæ”¯æŒéé˜»å¡ IO æ‰€æä¾›çš„ç›¸å…³ API ä»¥åŠé€šè¿‡ç¤ºä¾‹æ¥è¯´æ˜å®ƒä»¬çš„ä½¿ç”¨åœºæ™¯å’Œç”¨æ³•ã€‚"><meta property="og:url" content="http://example.org/posts/servlet-book/protocal-upgrades-and-no-blocking-io/"><meta property="og:site_name" content="å¢¨å®¢äººç”Ÿ"><meta property="og:title" content="ç¬¬å…«ç«  åè®®å‡çº§å’Œéé˜»å¡ IOã€éƒ¨åˆ†ã€‘"><meta property="og:description" content="Servlet æ‰€æä¾›çš„éé˜»å¡ IO ä»…å¯ä»¥åœ¨ Servlet å¼‚æ­¥å¤„ç†å’Œåè®®å‡çº§ä¸­ä½¿ç”¨ã€‚æˆ‘ä»¬åœ¨ç¬¬ä¸ƒç« å·²ç»è¯¦ç»†é˜è¿°äº† Servlet å¼‚æ­¥å¤„ç†ï¼Œå› æ­¤æœ¬ç« é¦–å…ˆç®€å•é˜è¿° Servlet å¯¹åè®®å‡çº§çš„æ”¯æŒï¼Œç„¶åé‡ç‚¹é˜è¿° Servlet ä¸ºæ”¯æŒéé˜»å¡ IO æ‰€æä¾›çš„ç›¸å…³ API ä»¥åŠé€šè¿‡ç¤ºä¾‹æ¥è¯´æ˜å®ƒä»¬çš„ä½¿ç”¨åœºæ™¯å’Œç”¨æ³•ã€‚"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-02-09T21:31:20+07:00"><meta property="article:modified_time" content="2025-02-09T21:31:20+07:00"><meta property="article:tag" content="åè®®å‡çº§"><meta property="article:tag" content="éé˜»å¡ IO"><meta property="og:see_also" content="http://example.org/posts/servlet-book/quality-assurance-practices-for-software-developers/"><link rel=canonical href=http://example.org/posts/servlet-book/protocal-upgrades-and-no-blocking-io/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.aa5ef26fa979d6793724ae2dbd71efa94fd16cb1c5c7db3b6651f21f9892a5fd.css integrity="sha256-ql7yb6l51nk3JK4tvXHvqU/RbLHFx9s7ZlHyH5iSpf0=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/img/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/img/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=http://example.org/>å¢¨å®¢äººç”Ÿ
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/life/>ç”Ÿæ´»</a></li><li class=navigation-item><a class=navigation-link href=/posts/>åšå®¢</a></li><li class=navigation-item><a class=navigation-link href=/about-me>å…³äºæˆ‘</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=http://example.org/posts/servlet-book/protocal-upgrades-and-no-blocking-io/>ç¬¬å…«ç«  åè®®å‡çº§å’Œéé˜»å¡ IOã€éƒ¨åˆ†ã€‘</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2025-02-09T21:31:20+07:00>February 9, 2025
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
é˜…è¯»æ—¶é—´ï¼š7 åˆ†é’Ÿ
</span><span class=post-word-count>| ğŸ‰ 3473 å­—</span></div><div class=authors><i class="fa-solid fa-user" aria-hidden=true></i>
<a href=/authors/mervyn/>Mervyn</a></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/%E5%8D%8F%E8%AE%AE%E5%8D%87%E7%BA%A7/>åè®®å‡çº§</a>
</span><span class=separator>â€¢</span>
<span class=tag><a href=/tags/%E9%9D%9E%E9%98%BB%E5%A1%9E-io/>éé˜»å¡ IO</a></span></div></div></header><div class=post-content><p>Servlet æ‰€æä¾›çš„éé˜»å¡ IO ä»…å¯ä»¥åœ¨ Servlet å¼‚æ­¥å¤„ç†å’Œåè®®å‡çº§ä¸­ä½¿ç”¨ã€‚æˆ‘ä»¬åœ¨ç¬¬ä¸ƒç« å·²ç»è¯¦ç»†é˜è¿°äº† Servlet å¼‚æ­¥å¤„ç†ï¼Œå› æ­¤æœ¬ç« é¦–å…ˆç®€å•é˜è¿° Servlet å¯¹åè®®å‡çº§çš„æ”¯æŒï¼Œç„¶åé‡ç‚¹é˜è¿° Servlet ä¸ºæ”¯æŒéé˜»å¡ IO æ‰€æä¾›çš„ç›¸å…³ API ä»¥åŠé€šè¿‡ç¤ºä¾‹æ¥è¯´æ˜å®ƒä»¬çš„ä½¿ç”¨åœºæ™¯å’Œç”¨æ³•ã€‚</p><h2 id=81-http-11-ä¸­çš„åè®®å‡çº§>8.1 HTTP 1.1 ä¸­çš„åè®®å‡çº§
<a class=heading-link href=#81-http-11-%e4%b8%ad%e7%9a%84%e5%8d%8f%e8%ae%ae%e5%8d%87%e7%ba%a7><i class="fa-solid fa-link" aria-hidden=true title=é“¾æ¥åˆ°æ ‡é¢˜></i>
<span class=sr-only>é“¾æ¥åˆ°æ ‡é¢˜</span></a></h2><p>åœ¨ HTTP/1.1 ä¸­ï¼Œé€šç”¨é¦–éƒ¨å­—æ®µä¸­çš„ Upgrade é¦–éƒ¨å…è®¸å®¢æˆ·ç«¯æŒ‡å®šå®ƒæ”¯æŒå¹¶å¸Œæœ›ä½¿ç”¨çš„å…¶ä»–é€šä¿¡åè®®ã€‚æ¯”å¦‚å¯ä»¥ä½¿ç”¨åè®®å‡çº§çš„æœºåˆ¶ï¼Œå°† HTTP/1.1 å‡çº§åˆ° TLS/1.0ã€HTTP/2ã€WebSocketç­‰å…¶ä»–åè®®ã€‚å¦‚æœæœåŠ¡å™¨ç«¯å…è®¸åˆ‡æ¢è‡³å®¢æˆ·ç«¯æœŸæœ›çš„é€šä¿¡åè®®ï¼Œåˆ™éœ€è¦æœåŠ¡å™¨ç«¯å¿…é¡»åœ¨å“åº”ä¸­ï¼Œä½¿ç”¨ Upgrade é¦–éƒ¨æŒ‡å®šæ­£åœ¨åˆ‡æ¢é‚£äº›åè®®å¹¶è¿”å› 101 çš„çŠ¶æ€ç ï¼ˆåˆ‡æ¢åè®®ï¼‰ã€‚å¦‚æœæœåŠ¡å™¨ç«¯ä¸å…è®¸åˆ‡æ¢è‡³å®¢æˆ·ç«¯æœŸæœ›çš„é€šä¿¡åè®®ï¼Œåˆ™éœ€è¦è¿”å› 200 çš„çŠ¶æ€ç çš„å“åº”ã€‚å°½ç®¡åˆ‡æ¢åè®®åçš„ç¬¬ä¸€ä¸ªåŠ¨ä½œå¿…é¡»æ˜¯å¯¹åˆå§‹ HTTP è¯·æ±‚å“åº”ï¼Œåœ¨è¿”å›è¯¥å“åº”ä¹‹åï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯çš„åº”ç”¨å±‚é€šä¿¡å®Œå…¨å–å†³äºæ‰€é€‰æ‹©çš„æ–°åè®®ã€‚</p><p>Upgrade é¦–éƒ¨å­—æ®µæ—¨åœ¨æä¾›ä¸€ç§ç®€å•çš„æœºåˆ¶ï¼Œç”¨äºä» HTTP/1.1 åˆ‡æ¢åˆ°å…¶ä»–ä¸€äº›ä¸å…¼å®¹çš„åè®®ã€‚Upgrade é¦–éƒ¨å­—æ®µåªé€‚ç”¨äºåŸºäºç°æœ‰ä¼ è¾“å±‚è¿æ¥çš„åè®®åˆ‡æ¢åº”ç”¨å±‚åè®®ã€‚ä¾‹å¦‚å…·æœ‰æ›´é«˜ç‰ˆæœ¬çš„ HTTP åè®®ï¼ŒWebSocket åè®®ç­‰ã€‚Upgrade é¦–éƒ¨å¯ä»¥æŒ‡å®šä¸€é¡¹æˆ–å¤šé¡¹åè®®åï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åºï¼Œå¹¶ä»¥é€—å·åˆ†éš”ã€‚</p><p>Upgrade é¦–éƒ¨å­—æ®µä»…é€‚ç”¨äºç›´æ¥è¿æ¥ã€‚å› æ­¤å‡çº§åè®®çš„å…³é”®æ˜¯ Upgrade é¦–éƒ¨å¿…é¡»ä¸ Connection é¦–éƒ¨ä¸€èµ·ä½¿ç”¨ï¼Œå¹¶ä¸”è¯¥ Connection é¦–éƒ¨çš„å€¼å¿…é¡»ä¸º Upgradeï¼Œè¿™æ„å‘³ç€æ§åˆ¶ä»£ç†ä¸å†è½¬å‘ Upgrade é¦–éƒ¨ã€‚</p><p>è¿™é‡Œä»¥ä» HTTP/1.1 å‡çº§è‡³ WebSocket ä¸ºç¤ºä¾‹æ¥è¯´æ˜è¯·æ±‚å’Œå“åº”çš„å˜åŒ–ã€‚</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>GET /chat HTTP/1.1
</span></span><span style=display:flex><span>Host: server.example.com
</span></span><span style=display:flex><span>Upgrade: websocket
</span></span><span style=display:flex><span>Connection: Upgrade
</span></span><span style=display:flex><span>Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
</span></span><span style=display:flex><span>Origin: http://example.com
</span></span><span style=display:flex><span>Sec-WebSocket-Protocol: chat, superchat
</span></span><span style=display:flex><span>Sec-WebSocket-Version: 13
</span></span></code></pre></div><p>å›¾ 8.1 åè®®å‡çº§è¯·æ±‚ç¤ºä¾‹</p><p>å¦‚å›¾ 8.1 æ‰€ç¤ºçš„åè®®å‡çº§è¯·æ±‚ç¤ºä¾‹ä¸­ï¼ŒUpgrade é¦–éƒ¨çš„å€¼ä¸º websocketï¼Œæ ‡æ˜å®¢æˆ·ç«¯æœŸæœ›å‡çº§åˆ° WebSocket åè®®ã€‚å¹¶ä¸” Connection çš„å€¼ä¸º Upgradeï¼Œæ ‡æ˜æ”¶åˆ°è¯¥è¯·æ±‚çš„æœåŠ¡å™¨æˆ–ä»£ç†æœåŠ¡å™¨å°†ä¸å†è½¬å‘ Upgrade é¦–éƒ¨ã€‚</p><ol><li>å¦‚æœæœåŠ¡å™¨ç«¯å…è®¸åˆ‡æ¢è‡³å®¢æˆ·ç«¯æœŸæœ›çš„ WebSocket åè®®ï¼Œåˆ™å¯¹åº”çš„å“åº”ç¤ºä¾‹å¦‚å›¾8.2æ‰€ç¤ºã€‚</li></ol><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>HTTP/1.1 101 Switching Protocols
</span></span><span style=display:flex><span>Upgrade: websocket
</span></span><span style=display:flex><span>Connection: Upgrade
</span></span><span style=display:flex><span>Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=
</span></span></code></pre></div><p>å›¾ 8.2 å…è®¸åè®®å‡çº§çš„å“åº”ç¤ºä¾‹</p><p>åœ¨å›¾8.2 ä¸­ï¼Œå“åº”çš„çŠ¶æ€ç ä¸º 101ï¼Œè¡¨æ˜æœåŠ¡å™¨ç«¯å…è®¸å®¢æˆ·ç«¯åˆ‡æ¢åè®®ã€‚Upgrade é¦–éƒ¨çš„å€¼ä¸º websocketï¼Œè¡¨æ˜åˆ‡æ¢åçš„åè®®ä¸º WebSocket åè®®ã€‚å¹¶ä¸” Connection çš„å€¼ä¸º Upgradeï¼Œè¡¨æ˜ä¸å†è½¬å‘ Upgrade é¦–éƒ¨ã€‚åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯åç»­çš„é€šä¿¡ä¸­ï¼Œæ‰€ä½¿ç”¨çš„é€šä¿¡åè®®å°†ä¼šæ˜¯ WebSocket åè®®ã€‚å…è®¸åè®®å‡çº§çš„ç¤ºæ„å›¾å¦‚å›¾8.3æ‰€ç¤ºã€‚</p><p><img src=/servlet-book/protocal-upgrades-and-no-blocking-IO/server_allow_to_switch_protocol.png alt=server_allow_to_switch_protocol.png></p><p>å›¾ 8.3 å…è®¸åè®®å‡çº§çš„ç¤ºæ„å›¾</p><ol start=2><li>å¦‚æœæœåŠ¡å™¨ç«¯ä¸å…è®¸åˆ‡æ¢è‡³å®¢æˆ·ç«¯æœŸæœ›çš„ WebSocket åè®®ï¼Œåˆ™å¯¹åº”çš„å“åº”ç¤ºä¾‹å¦‚å›¾8.4æ‰€ç¤ºã€‚</li></ol><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>HTTP/1.1 200 ok
</span></span></code></pre></div><p>å›¾ 8.4 ä¸å…è®¸åè®®å‡çº§çš„å“åº”ç¤ºä¾‹</p><p>åœ¨å›¾8.4 ä¸­ï¼Œå“åº”çš„çŠ¶æ€ç ä¸º 200ï¼Œæ ‡æ˜æœåŠ¡å™¨ç«¯ä¸å…è®¸å®¢æˆ·ç«¯å°†åè®®åˆ‡æ¢å€¼ WebSocket åè®®ã€‚ä¸å…è®¸åè®®å‡çº§çš„ç¤ºæ„å›¾å¦‚å›¾8.5æ‰€ç¤ºã€‚</p><p><img src=/servlet-book/protocal-upgrades-and-no-blocking-IO/server_not_allow_to_switch_protocol.png alt=server_not_allow_to_switch_protocol.png></p><p>å›¾ 8.5 ä¸å…è®¸åè®®å‡çº§çš„ç¤ºæ„å›¾</p><h2 id=82-servlet-å¯¹åè®®å‡çº§çš„æ”¯æŒ>8.2 Servlet å¯¹åè®®å‡çº§çš„æ”¯æŒ
<a class=heading-link href=#82-servlet-%e5%af%b9%e5%8d%8f%e8%ae%ae%e5%8d%87%e7%ba%a7%e7%9a%84%e6%94%af%e6%8c%81><i class="fa-solid fa-link" aria-hidden=true title=é“¾æ¥åˆ°æ ‡é¢˜></i>
<span class=sr-only>é“¾æ¥åˆ°æ ‡é¢˜</span></a></h2><p>è™½ç„¶ Servlet å®¹å™¨æä¾›å¯¹ HTTP åè®®å‡çº§çš„æ”¯æŒï¼Œä½†æ˜¯ Servlet å®¹å™¨æœ¬èº«å¹¶ä¸çŸ¥é“å‡çº§åçš„åè®®ã€‚å› æ­¤ Servlet è§„èŒƒä¸­æä¾›äº† HttpUpgradeHandler æ¥å£ï¼Œå‡çº§åçš„åè®®å¤„ç†å°è£…åœ¨ HttpUpgradeHandler æ¥å£ä¸­ã€‚Servlet å®¹å™¨å’Œ HttpUpgradeHandler ä¹‹é—´çš„æ•°æ®è¯»å–æˆ–å†™å…¥æ˜¯å­—èŠ‚æµã€‚</p><p>å½“ Servlet å®¹å™¨æ¥æ”¶åˆ°å‡çº§åè®®è¯·æ±‚æ—¶ï¼Œå¦‚æœ Servlet ä¸å…è®¸åè®®å‡çº§ï¼Œé‚£ä¹ˆåœ¨ Servlet ä¸­ç›´æ¥è¿”å› 200 çš„çŠ¶æ€ç å“åº”å³å¯ã€‚å¦‚æœ Servlet å…è®¸åè®®å‡çº§ï¼Œé‚£ä¹ˆ Servlet é¦–å…ˆéœ€è¦åœ¨å“åº”ä¸­è®¾ç½® Upgrade ç­‰é¦–éƒ¨å’Œ 101 çš„çŠ¶æ€ç ã€‚ç„¶å Servlet è¿˜éœ€è¦è°ƒç”¨ HttpServletRequest.upgrade æ–¹æ³•ï¼Œç”¨æ¥å¯åŠ¨åè®®å‡çº§è¿‡ç¨‹ã€‚å®Œæˆä¸Šè¿°ä¸¤é¡¹å·¥ä½œä¹‹åï¼Œå¤„ç†åè®®å‡çº§çš„çº¿ç¨‹ä¾æ¬¡é€€å‡º Servlet çš„ service æ–¹æ³•å’Œè¿‡æ»¤å™¨ï¼Œå¹¶æ ‡è®°è¿æ¥ç”± HttpUpgradeHandler æ¥å£çš„å®ç°ç±»æ¥å¤„ç†ï¼ŒåŒæ—¶å°†å…è®¸åè®®å‡çº§çš„å“åº”ç»“æœè¿”å›å®¢æˆ·ç«¯ï¼Œæ­¤æ—¶åè®®å‡çº§ç»“æŸã€‚Servlet å’Œè¿‡æ»¤å™¨åªå¤„ç†åˆå§‹çš„ HTTP è¯·æ±‚å’Œå“åº”ã€‚ä»–ä»¬ä¸å‚ä¸åç»­é€šä¿¡ã€‚æ¢å¥è¯è¯´ï¼Œä¸€æ—¦è¯·æ±‚å‡çº§ï¼Œå®ƒä»¬å°±ä¸ä¼šè¢«è°ƒç”¨ã€‚åè®®å‡çº§ç»“æŸä¹‹åï¼Œè¿æ¥å¹¶æ²¡æœ‰æ–­æ‰ï¼Œåç»­çš„è¯·æ±‚é€šè¿‡å‡çº§ä¹‹åçš„åè®®ä¸æœåŠ¡ç«¯è¿›è¡Œé€šä¿¡ã€‚å½“ Servlet å®¹å™¨æ”¶åˆ°åŸºäºè¯¥è¿æ¥çš„åç»­è¯·æ±‚æ—¶ï¼Œä¾¿ä¼šè°ƒç”¨ HttpUpgradeHandler æ¥å£å®ç°ç±»çš„ init æ–¹æ³•ï¼Œå¹¶ä¼ é€’ WebConnection ä»¥å…è®¸åè®®å¤„ç†ç¨‹åºè®¿é—®æ•°æ®æµã€‚HttpUpgradeHandler æ¥å£å®ç°ç±»å¯¹è±¡å¯ä»¥é€šè¿‡ WebConnection å¯¹è±¡æ“ä½œè¾“å…¥æµå’Œè¾“å‡ºæµï¼Œä»¥å®ç°ä¸å®¢æˆ·ç«¯çš„é€šä¿¡ã€‚å½“ç„¶ HttpUpgradeHandler æ¥å£çš„å®ç°ç±»ä¹Ÿå¯ä»¥ä½¿ç”¨éé˜»å¡ IO æ¥æ¶ˆè´¹å’Œç”Ÿæˆæ¶ˆæ¯ã€‚å½“å®¢æˆ·ç«¯æ–­å¼€è¿æ¥ä¹‹åï¼Œå®¹å™¨ä¼šè°ƒç”¨ HttpUpgradeHandler æ¥å£å®ç°ç±»å¯¹è±¡çš„ destroy æ–¹æ³•ï¼Œæ‰§è¡Œèµ„æºæ¸…ç†ç­‰æ“ä½œã€‚</p><p>è¿™é‡Œä»¥ä» HTTP 1.1 å‡çº§è‡³ WebSocket ä¸ºç¤ºä¾‹æ¥è¯´æ˜ Servlet å¯¹åè®®å‡çº§çš„æ”¯æŒã€‚å¦‚ä»£ç æ¸…å• 8.1 æ‰€ç¤ºï¼ŒUpgradeServlet æ˜¯ä¸€ä¸ªæ”¯æŒ WebSocket åè®®å‡çº§çš„ Servlet æœåŠ¡ã€‚å½“å®¢æˆ·ç«¯å‘é€ HTTP è¯·æ±‚åˆ° UpgradeServlet æ—¶ï¼ŒUpgradeServlet ä¼šæ£€æŸ¥è¯·æ±‚ä¸­çš„ Upgrade é¦–éƒ¨æ˜¯å¦ä¸º websocketï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è°ƒç”¨ HttpServletRequest.upgrade æ–¹æ³•ï¼Œå¯åŠ¨åè®®å‡çº§è¿‡ç¨‹ã€‚HttpServletRequest.upgrade æ–¹æ³•çš„å‚æ•°æ˜¯ä¸€ä¸ªå®ç°äº† HttpUpgradeHandler æ¥å£çš„ç±» WebSocketUpgradeHandlerï¼Œè¯¥æ–¹æ³•ä¼šå®ä¾‹åŒ–ä¸€ä¸ª WebSocketUpgradeHandler å®ä¾‹ã€‚åœ¨ UpgradeServlet ä¸­ï¼Œæˆ‘ä»¬è¿˜è®¾ç½®äº†å“åº”çš„çŠ¶æ€ç ä¸º 101ï¼ŒåŒæ—¶è®¾ç½®äº† Upgradeã€Connection å’Œ Sec-WebSocket-Accept ç­‰é¦–éƒ¨ï¼Œè¡¨æ˜æœåŠ¡ç«¯æ”¯æŒåˆ‡æ¢è‡³ WebSocket åè®®ã€‚å¦‚æœä¸æ˜¯ï¼Œåˆ™è¿”å› 200 çš„çŠ¶æ€ç å“åº”ï¼Œè¡¨æ˜æœåŠ¡ç«¯ä¸æ”¯æŒåˆ‡æ¢è‡³å…¶ä»–åè®®ã€‚</p><p>ä»£ç æ¸…å• 8.1 æ”¯æŒ WebSocket è¿›è¡Œåè®®å‡çº§çš„ Servlet æœåŠ¡ï¼šUpgradeServlet.java</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>package</span><span style=color:#6e7681> </span><span style=color:#ff7b72>com.mervyn.book.servlet</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>com.mervyn.book.servlet.utils.SecWebSocketAcceptUtil.generateSecWebSocketAccept</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>com.google.common.net.HttpHeaders</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.servlet.ServletException</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.servlet.annotation.WebServlet</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.servlet.http.HttpServlet</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.servlet.http.HttpServletRequest</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.servlet.http.HttpServletResponse</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>java.io.IOException</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.slf4j.Logger</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#d2a8ff;font-weight:700>@WebServlet</span>(urlPatterns<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;/upgrade&#34;</span>)<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>UpgradeServlet</span><span style=color:#6e7681> </span><span style=color:#ff7b72>extends</span><span style=color:#6e7681> </span>HttpServlet<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span><span style=color:#ff7b72>static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>final</span><span style=color:#6e7681> </span>Logger<span style=color:#6e7681> </span>LOGGER<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>org.slf4j.LoggerFactory.getLogger(UpgradeServlet.class);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#d2a8ff;font-weight:700>@Override</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>protected</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>doGet</span>(HttpServletRequest<span style=color:#6e7681> </span>request,<span style=color:#6e7681> </span>HttpServletResponse<span style=color:#6e7681> </span>response)<span style=color:#6e7681> </span><span style=color:#ff7b72>throws</span><span style=color:#6e7681> </span>ServletException,<span style=color:#6e7681> </span>IOException<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>LOGGER.info(<span style=color:#a5d6ff>&#34;Upgrade request received&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>String<span style=color:#6e7681> </span>upgradeHeader<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>request.getHeader(<span style=color:#a5d6ff>&#34;Upgrade&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>if</span><span style=color:#6e7681> </span>(upgradeHeader<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>!=</span><span style=color:#6e7681> </span><span style=color:#79c0ff>null</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>&amp;&amp;</span><span style=color:#6e7681> </span>upgradeHeader.equals(<span style=color:#a5d6ff>&#34;websocket&#34;</span>))<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>request.upgrade(WebSocketUpgradeHandler.class);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>response.setStatus(HttpServletResponse.SC_SWITCHING_PROTOCOLS);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>response.setHeader(HttpHeaders.CONNECTION,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;Upgrade&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>response.setHeader(HttpHeaders.UPGRADE,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;websocket&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>response.setHeader(HttpHeaders.SEC_WEBSOCKET_ACCEPT,<span style=color:#6e7681> </span>generateSecWebSocketAccept(request.getHeader(HttpHeaders.SEC_WEBSOCKET_KEY)));<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681> </span><span style=color:#ff7b72>else</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>response.setStatus(HttpServletResponse.SC_OK);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>LOGGER.info(<span style=color:#a5d6ff>&#34;Upgrade request ended&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>}<span style=color:#6e7681>
</span></span></span></code></pre></div><p>åœ¨ä»£ç æ¸…å• 8.2 ä¸­ï¼ŒWebSocketUpgradeHandler æ˜¯ä¸€ä¸ªå®ç°äº† HttpUpgradeHandler æ¥å£çš„ç±»ï¼Œåœ¨åè®®å‡çº§ä¹‹åç”¨æ¥å¤„ç†æ¥è‡ªå®¢æˆ·ç«¯çš„ WebSocket è¯·æ±‚ï¼Œå¹¶ç»™äºˆå®¢æˆ·ç«¯ç›¸åº”çš„å“åº”ã€‚ä¸€æ—¦ HTTP å‡çº§è¿‡ç¨‹å®Œæˆå¹¶ä¸”å‡çº§åçš„è¿æ¥å‡†å¤‡å¥½å¼€å§‹ä½¿ç”¨æ–°åè®®ï¼ŒServlet å®¹å™¨å°±ä¼šè°ƒç”¨ HttpUpgradeHandleræ¥å£çš„ init æ–¹æ³•ã€‚WebSocketUpgradeHandler åœ¨å…¶ init æ–¹æ³•ä¸­ï¼Œæˆ‘å°†å¤„ç†å®¢æˆ·ç«¯ WebSocket è¯·æ±‚çš„ä»»åŠ¡å°è£…æˆä¸€ä¸ª
ReadMessageDirectOutputRunnable ä»»åŠ¡ï¼Œå¹¶äº¤ç”±ä¸šåŠ¡çº¿ç¨‹æ± æ¥å¤„ç†ã€‚å½“å®¢æˆ·ç«¯æ–­å¼€è¿æ¥ä¹‹åï¼Œå®¹å™¨ä¼šè°ƒç”¨ WebSocketUpgradeHandler çš„ destroy æ–¹æ³•ï¼Œæ‰§è¡Œèµ„æºæ¸…ç†ç­‰æ“ä½œã€‚</p><p>ä»£ç æ¸…å• 8.2 åè®®å‡çº§ä¹‹åï¼ŒåŸºäº WebSocket å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚å’Œå“åº”çš„ HttpUpgradeHandler å®ç°ç±»ï¼šWebSocketUpgradeHandler.java</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>package</span><span style=color:#6e7681> </span><span style=color:#ff7b72>com.mervyn.book.servlet</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>com.mervyn.book.servlet.utils.ExecutorServiceConfig</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.servlet.http.HttpUpgradeHandler</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.servlet.http.WebConnection</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.slf4j.Logger</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>WebSocketUpgradeHandler</span><span style=color:#6e7681> </span><span style=color:#ff7b72>implements</span><span style=color:#6e7681> </span>HttpUpgradeHandler<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span><span style=color:#ff7b72>static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>final</span><span style=color:#6e7681> </span>Logger<span style=color:#6e7681> </span>LOGGER<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>org.slf4j.LoggerFactory.getLogger(WebSocketUpgradeHandler.class);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span>WebConnection<span style=color:#6e7681> </span>webConnection;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#d2a8ff;font-weight:700>@Override</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>init</span>(WebConnection<span style=color:#6e7681> </span>webConnection)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>this</span>.webConnection<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>webConnection<span style=color:#6e7681> </span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>ExecutorServiceConfig.getExecutorService()<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.submit(<span style=color:#ff7b72>new</span><span style=color:#6e7681> </span>ReadMessageDirectOutputRunnable(<span style=color:#ff7b72>this</span>.webConnection));<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#d2a8ff;font-weight:700>@Override</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>destroy</span>()<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>try</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#ff7b72>if</span><span style=color:#6e7681> </span>(webConnection<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>!=</span><span style=color:#6e7681> </span><span style=color:#79c0ff>null</span>)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>LOGGER.info(<span style=color:#a5d6ff>&#34;Closing connection&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>webConnection.close();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681> </span><span style=color:#ff7b72>catch</span><span style=color:#6e7681> </span>(Exception<span style=color:#6e7681> </span>e)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>LOGGER.error(<span style=color:#a5d6ff>&#34;Failed to close connection&#34;</span>,<span style=color:#6e7681> </span>e);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>}<span style=color:#6e7681>
</span></span></span></code></pre></div><p>åœ¨ä»£ç æ¸…å• 8.3 ä¸­ï¼ŒReadMessageDirectOutputRunnable æ˜¯ä¸€ä¸ªå®ç°äº† Runnable æ¥å£çš„ç±»ï¼Œç”¨æ¥å¤„ç†ä¸ WebSocket å®¢æˆ·ç«¯è¯·æ±‚çš„ä»»åŠ¡ã€‚åœ¨è¯¥ä»»åŠ¡ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ WebConnection å¯¹è±¡è·å–è¾“å…¥æµå’Œè¾“å‡ºæµï¼Œç„¶åé€šè¿‡ WebSocketDataFrameUtil å·¥å…·ç±»æ¥è¯»å–å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯ï¼Œå¹¶å°†æ¶ˆæ¯å†™å›å®¢æˆ·ç«¯ã€‚å¦‚æœå®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯ä¸º WebSocket å…³é—­å¸§ï¼Œåˆ™æˆ‘ä»¬é€šè¿‡ WebSocketDataFrameUtil å·¥å…·ç±»æ¥å‘é€å…³é—­å¸§ï¼Œå¹¶å…³é—­è¿æ¥ã€‚</p><p>ä»£ç æ¸…å• 8.3 ä½¿ç”¨ WebConnection å¤„ç†ä¸ WebSocket å®¢æˆ·ç«¯è¯·æ±‚çš„ä»»åŠ¡ï¼šReadMessageDirectOutputRunnable</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>package</span><span style=color:#6e7681> </span><span style=color:#ff7b72>com.mervyn.book.servlet</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>com.mervyn.book.servlet.utils.WebSocketDataFrameUtil.readPayloadFromDataFrame</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>com.mervyn.book.servlet.utils.WebSocketDataFrameUtil.sendCloseViaDataFrame</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>com.mervyn.book.servlet.utils.WebSocketDataFrameUtil.writePayloadToDataFrame</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.servlet.http.WebConnection</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>java.io.IOException</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>java.io.InputStream</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>java.io.OutputStream</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.slf4j.Logger</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>ReadMessageDirectOutputRunnable</span><span style=color:#6e7681> </span><span style=color:#ff7b72>implements</span><span style=color:#6e7681> </span>Runnable<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span><span style=color:#ff7b72>static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>final</span><span style=color:#6e7681> </span>Logger<span style=color:#6e7681> </span>LOGGER<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>org.slf4j.LoggerFactory.getLogger(ReadMessageDirectOutputRunnable.class);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span>WebConnection<span style=color:#6e7681> </span>webConnection;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>ReadMessageDirectOutputRunnable</span>(WebConnection<span style=color:#6e7681> </span>connection)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>this</span>.webConnection<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>connection;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#d2a8ff;font-weight:700>@Override</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>run</span>()<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>try</span><span style=color:#6e7681> </span>(InputStream<span style=color:#6e7681> </span>inputStream<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>webConnection.getInputStream();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>             </span>OutputStream<span style=color:#6e7681> </span>outputStream<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>webConnection.getOutputStream())<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#ff7b72>while</span><span style=color:#6e7681> </span>(<span style=color:#79c0ff>true</span>)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span><span style=color:#ff7b72>try</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                    </span>String<span style=color:#6e7681> </span>payload<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>readPayloadFromDataFrame(inputStream);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                    </span>LOGGER.info(<span style=color:#a5d6ff>&#34;Received message from client: {}&#34;</span>,<span style=color:#6e7681> </span>payload);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                    </span>writePayloadToDataFrame(outputStream,<span style=color:#6e7681> </span>payload,<span style=color:#6e7681> </span><span style=color:#79c0ff>false</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>}<span style=color:#6e7681> </span><span style=color:#ff7b72>catch</span><span style=color:#6e7681> </span>(WebSocketCloseException<span style=color:#6e7681> </span>e)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                    </span>LOGGER.info(<span style=color:#a5d6ff>&#34;WebSocket closing the connection&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                    </span>sendCloseViaDataFrame(outputStream,<span style=color:#6e7681> </span>1000,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;Normal closure&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                    </span><span style=color:#ff7b72>break</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681> </span><span style=color:#ff7b72>catch</span><span style=color:#6e7681> </span>(IOException<span style=color:#6e7681> </span>e)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>LOGGER.info(<span style=color:#a5d6ff>&#34;Failed to read or write WebSocket data&#34;</span>,<span style=color:#6e7681> </span>e);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>}<span style=color:#6e7681>
</span></span></span></code></pre></div><p>æˆ‘ä»¬éœ€è¦ä¸€ä¸ª WebSocket å®¢æˆ·ç«¯ä»£ç éªŒè¯ï¼ŒUpgradeServlet ä¸­åè®®å‡çº§çš„åŠŸèƒ½ã€‚å¦‚ä»£ç æ¸…å• 8.4 æ‰€ç¤ºï¼Œè¯¥ WebSocket å®¢æˆ·ç«¯é¦–å…ˆä¼šè¿æ¥åˆ° UpgradeServletï¼Œç„¶åå‘é€æ¶ˆæ¯ Helloï¼Œ5 ç§’åå‘é€æ¶ˆæ¯ Goodbyeï¼Œ2 ç§’åå…³é—­è¿æ¥ã€‚</p><p>ä»£ç æ¸…å• 8.4 å‘ UpgradeServlet å‘é€è¯·æ±‚çš„ WebSocket å®¢æˆ·ç«¯ï¼šWebSocketClient</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>package</span><span style=color:#6e7681> </span><span style=color:#ff7b72>com.mervyn.book.servlet</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.websocket.ClientEndpoint</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.websocket.CloseReason</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.websocket.ContainerProvider</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.websocket.OnClose</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.websocket.OnError</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.websocket.OnMessage</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.websocket.OnOpen</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.websocket.Session</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.websocket.WebSocketContainer</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>java.net.URI</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>java.util.concurrent.TimeUnit</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.slf4j.Logger</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#d2a8ff;font-weight:700>@ClientEndpoint</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>WebSocketClient</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span><span style=color:#ff7b72>static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>final</span><span style=color:#6e7681> </span>String<span style=color:#6e7681> </span>SERVER_URI<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;ws://localhost:8080/upgrade&#34;</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span><span style=color:#ff7b72>static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>final</span><span style=color:#6e7681> </span>Logger<span style=color:#6e7681> </span>LOGGER<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>org.slf4j.LoggerFactory.getLogger(WebSocketClient.class);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#d2a8ff;font-weight:700>@OnOpen</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>onOpen</span>(Session<span style=color:#6e7681> </span>session)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>LOGGER.info(<span style=color:#a5d6ff>&#34;Connected to server&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>try</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>session.getBasicRemote().sendText(<span style=color:#a5d6ff>&#34;Hello&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>LOGGER.info(<span style=color:#a5d6ff>&#34;Send message to server&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681> </span><span style=color:#ff7b72>catch</span><span style=color:#6e7681> </span>(Exception<span style=color:#6e7681> </span>e)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>LOGGER.error(<span style=color:#a5d6ff>&#34;Failed to send message to server&#34;</span>,<span style=color:#6e7681> </span>e);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#d2a8ff;font-weight:700>@OnMessage</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>onMessage</span>(String<span style=color:#6e7681> </span>message)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>if</span><span style=color:#6e7681> </span>(LOGGER.isInfoEnabled())<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>LOGGER.info(<span style=color:#a5d6ff>&#34;Received message from server: &#34;</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>+</span><span style=color:#6e7681> </span>message);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#d2a8ff;font-weight:700>@OnClose</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>onClose</span>(Session<span style=color:#6e7681> </span>session,<span style=color:#6e7681> </span>CloseReason<span style=color:#6e7681> </span>closeReason)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>if</span><span style=color:#6e7681> </span>(LOGGER.isInfoEnabled())<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>LOGGER.info(<span style=color:#a5d6ff>&#34;Session closed: &#34;</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>+</span><span style=color:#6e7681> </span>closeReason);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#d2a8ff;font-weight:700>@OnError</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>onError</span>(Session<span style=color:#6e7681> </span>session,<span style=color:#6e7681> </span>Throwable<span style=color:#6e7681> </span>thr)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>if</span><span style=color:#6e7681> </span>(LOGGER.isErrorEnabled())<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>LOGGER.error(<span style=color:#a5d6ff>&#34;Error occurred in session: {}&#34;</span>,<span style=color:#6e7681> </span>session.getId(),<span style=color:#6e7681> </span>thr);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>main</span>(String<span style=color:#ff7b72;font-weight:700>[]</span><span style=color:#6e7681> </span>args)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>WebSocketContainer<span style=color:#6e7681> </span>container<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>ContainerProvider.getWebSocketContainer();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>try</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>URI<span style=color:#6e7681> </span>uri<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#ff7b72>new</span><span style=color:#6e7681> </span>URI(SERVER_URI);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>Session<span style=color:#6e7681> </span>session<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>container.connectToServer(WebSocketClient.class,<span style=color:#6e7681> </span>uri);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>TimeUnit.SECONDS.sleep(5);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>session.getBasicRemote().sendText(<span style=color:#a5d6ff>&#34;Goodbye&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>TimeUnit.SECONDS.sleep(2);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>session.close();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681> </span><span style=color:#ff7b72>catch</span><span style=color:#6e7681> </span>(Exception<span style=color:#6e7681> </span>e)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>LOGGER.error(<span style=color:#a5d6ff>&#34;Failed to connect to server&#34;</span>,<span style=color:#6e7681> </span>e);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>}<span style=color:#6e7681>
</span></span></span></code></pre></div><p>é€šè¿‡ä»£ç æ¸…å• 8.4 æ‰€ç¤ºçš„ WebSocket å®¢æˆ·ç«¯å‘ä»£ç æ¸…å• 8.1 ä¸­çš„ UpgradeServlet æœåŠ¡ç«¯å‘é€è¯·æ±‚ã€‚æˆ‘ä»¬å¯ä»¥ä»æœåŠ¡ç«¯çœ‹åˆ°ï¼Œå›¾ 8.6 æ‰€ç¤ºçš„æœåŠ¡ç«¯æ—¥å¿—ã€‚ä»å›¾ 8.6 ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒUpgradeServlet æ¥æ”¶åˆ°äº†åè®®å‡çº§çš„è¯·æ±‚ï¼Œå¹¶ä¸”æˆåŠŸå‡çº§åˆ°äº† WebSocket åè®®ã€‚åœ¨å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ Hello å’Œ Goodbye ä¹‹åï¼ŒæœåŠ¡ç«¯åˆ†åˆ«æ¥æ”¶åˆ°äº†æ¶ˆæ¯ Hello å’Œ Goodbyeï¼Œå¹¶å°†æ¶ˆæ¯ Hello å’Œ Goodbye åˆ†åˆ«å‘é€å›å®¢æˆ·ç«¯ã€‚æœ€åï¼ŒæœåŠ¡ç«¯å…³é—­äº† WebSocket è¿æ¥ã€‚</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>11:33:45.015 [http-nio-8080-exec-1] INFO com.mervyn.book.servlet.UpgradeServlet -- Upgrade request received
</span></span><span style=display:flex><span>11:33:45.018 [http-nio-8080-exec-1] INFO com.mervyn.book.servlet.UpgradeServlet -- Upgrade request ended
</span></span><span style=display:flex><span>11:33:45.033 [business-thread-0] INFO com.mervyn.book.servlet.ReadMessageDirectOutputRunnable -- Received message from client: Hello
</span></span><span style=display:flex><span>11:33:50.038 [business-thread-0] INFO com.mervyn.book.servlet.ReadMessageDirectOutputRunnable -- Received message from client: Goodbye
</span></span><span style=display:flex><span>11:33:52.045 [business-thread-0] INFO com.mervyn.book.servlet.ReadMessageDirectOutputRunnable -- WebSocket closing the connection
</span></span></code></pre></div><p>å›¾ 8.6 Servlet å¤„ç† WebSocket åè®®å‡çº§æœåŠ¡ç«¯ç¤ºä¾‹çš„æ—¥å¿—</p><p>æœ¬èŠ‚ä»…ä»…é€šè¿‡ç®€å•çš„ç¤ºä¾‹ï¼Œæ¼”ç¤ºäº† Servlet å¦‚ä½•å°† HTTP 1.1 å‡çº§è‡³ WebSocket åè®®ã€‚å®é™…ä¸Š HTTP 1.1 å‡çº§è‡³ WebSocket åè®®çš„ HttpUpgradeHandler æ¥å£å®ç°ç±»æ¯”æˆ‘ä»¬çš„ç¤ºä¾‹è¦å¤æ‚å¾—å¤šã€‚å½“ç„¶ä¹Ÿä¸éœ€è¦æˆ‘ä»¬è‡ªå·±å¼€å‘ã€‚Servlet å®¹å™¨çš„å‚å•†å¾€å¾€ä¼šæä¾›æˆç†Ÿçš„å®ç°ï¼Œå…·ä½“å¯ä»¥å‚è€ƒç›¸å…³ Servlet å®¹å™¨çš„å®ç°ã€‚ä¾‹å¦‚ï¼ŒTomcat çš„ WebSocket åè®®å‡çº§å®ç°ç±»æ˜¯ <code>org.apache.tomcat.websocket.server.WsHttpUpgradeHandler</code>ã€‚å¯¹äºå‡çº§è‡³å…¶ä»–åè®®ï¼Œä¹Ÿå¯ä»¥å‚è€ƒç›¸å…³ Servlet å®¹å™¨çš„å®ç°ã€‚</p></div><div style="text-align:center;color:#a9a9a9;width:50%;margin:0 auto"><p>æœ¬ä½œå“é‡‡ç”¨<a href=http://creativecommons.org/licenses/by-nc-nd/4.0/ style=color:#a9a9a9>çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç¦æ­¢æ¼”ç» 4.0 å›½é™…è®¸å¯åè®®</a>è¿›è¡Œè®¸å¯</p></div><div style="border-bottom-style:dashed;border-bottom-style:inset;border-bottom-width:2px;width:50%;margin:0 auto"></div><footer><section class=see-also><h3 id=å‚è§-servlet-book>å‚è§ servlet-book
<a class=heading-link href=#%e5%8f%82%e8%a7%81-servlet-book><i class="fa-solid fa-link" aria-hidden=true title=é“¾æ¥åˆ°æ ‡é¢˜></i>
<span class=sr-only>é“¾æ¥åˆ°æ ‡é¢˜</span></a></h3><nav><ul><li><a href=/posts/servlet-book/quality-assurance-practices-for-software-developers/>è½¯ä»¶ç ”å‘äººå‘˜çš„è´¨é‡ä¿è¯å®è·µã€éƒ¨åˆ†ã€‘</a></li></ul></nav></section><div class=comments><script>let getTheme=window.localStorage&&window.localStorage.getItem("colorscheme");getTheme=getTheme??"light";let s=document.createElement("script");s.src="https://giscus.app/client.js",s.setAttribute("data-repo","csmervyn/csmervyn.github.io"),s.setAttribute("data-repo-id","R_kgDOGbYn4A"),s.setAttribute("data-category","Announcements"),s.setAttribute("data-category-id","DIC_kwDOGbYn4M4CWQYR"),s.setAttribute("data-mapping","pathname"),s.setAttribute("data-term",""),s.setAttribute("data-strict","0"),s.setAttribute("data-reactions-enabled","1"),s.setAttribute("data-emit-metadata","0"),s.setAttribute("data-input-position","bottom"),s.setAttribute("data-theme",getTheme),s.setAttribute("data-lang","zh-CN"),s.setAttribute("data-loading",""),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.comments").innerHTML="",document.querySelector("div.comments").appendChild(s)</script></div></footer></article></section></div><footer class=footer><section class=container>Â©
2019 -
2025
Mervyn
Â·
æŠ€æœ¯æ”¯æŒ <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>