<!doctype html><html lang=zh-cn><head><title>第八章 协议升级和非阻塞 IO【部分】 · 墨客人生
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Mervyn"><meta name=description content="Servlet 所提供的非阻塞 IO 仅可以在 Servlet 异步处理和协议升级中使用。我们在第七章已经详细阐述了 Servlet 异步处理，因此本章首先简单阐述 Servlet 对协议升级的支持，然后重点阐述 Servlet 为支持非阻塞 IO 所提供的相关 API 以及通过示例来说明它们的使用场景和用法。"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="第八章 协议升级和非阻塞 IO【部分】"><meta name=twitter:description content="Servlet 所提供的非阻塞 IO 仅可以在 Servlet 异步处理和协议升级中使用。我们在第七章已经详细阐述了 Servlet 异步处理，因此本章首先简单阐述 Servlet 对协议升级的支持，然后重点阐述 Servlet 为支持非阻塞 IO 所提供的相关 API 以及通过示例来说明它们的使用场景和用法。"><meta property="og:url" content="http://example.org/posts/servlet-book/protocal-upgrades-and-no-blocking-io/"><meta property="og:site_name" content="墨客人生"><meta property="og:title" content="第八章 协议升级和非阻塞 IO【部分】"><meta property="og:description" content="Servlet 所提供的非阻塞 IO 仅可以在 Servlet 异步处理和协议升级中使用。我们在第七章已经详细阐述了 Servlet 异步处理，因此本章首先简单阐述 Servlet 对协议升级的支持，然后重点阐述 Servlet 为支持非阻塞 IO 所提供的相关 API 以及通过示例来说明它们的使用场景和用法。"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-02-09T21:31:20+07:00"><meta property="article:modified_time" content="2025-02-09T21:31:20+07:00"><meta property="article:tag" content="协议升级"><meta property="article:tag" content="非阻塞 IO"><meta property="og:see_also" content="http://example.org/posts/servlet-book/quality-assurance-practices-for-software-developers/"><link rel=canonical href=http://example.org/posts/servlet-book/protocal-upgrades-and-no-blocking-io/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.aa5ef26fa979d6793724ae2dbd71efa94fd16cb1c5c7db3b6651f21f9892a5fd.css integrity="sha256-ql7yb6l51nk3JK4tvXHvqU/RbLHFx9s7ZlHyH5iSpf0=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/img/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/img/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=http://example.org/>墨客人生
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/life/>生活</a></li><li class=navigation-item><a class=navigation-link href=/posts/>博客</a></li><li class=navigation-item><a class=navigation-link href=/about-me>关于我</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=http://example.org/posts/servlet-book/protocal-upgrades-and-no-blocking-io/>第八章 协议升级和非阻塞 IO【部分】</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2025-02-09T21:31:20+07:00>February 9, 2025
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
阅读时间：7 分钟
</span><span class=post-word-count>| 🍉 3473 字</span></div><div class=authors><i class="fa-solid fa-user" aria-hidden=true></i>
<a href=/authors/mervyn/>Mervyn</a></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/%E5%8D%8F%E8%AE%AE%E5%8D%87%E7%BA%A7/>协议升级</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/%E9%9D%9E%E9%98%BB%E5%A1%9E-io/>非阻塞 IO</a></span></div></div></header><div class=post-content><p>Servlet 所提供的非阻塞 IO 仅可以在 Servlet 异步处理和协议升级中使用。我们在第七章已经详细阐述了 Servlet 异步处理，因此本章首先简单阐述 Servlet 对协议升级的支持，然后重点阐述 Servlet 为支持非阻塞 IO 所提供的相关 API 以及通过示例来说明它们的使用场景和用法。</p><h2 id=81-http-11-中的协议升级>8.1 HTTP 1.1 中的协议升级
<a class=heading-link href=#81-http-11-%e4%b8%ad%e7%9a%84%e5%8d%8f%e8%ae%ae%e5%8d%87%e7%ba%a7><i class="fa-solid fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><p>在 HTTP/1.1 中，通用首部字段中的 Upgrade 首部允许客户端指定它支持并希望使用的其他通信协议。比如可以使用协议升级的机制，将 HTTP/1.1 升级到 TLS/1.0、HTTP/2、WebSocket等其他协议。如果服务器端允许切换至客户端期望的通信协议，则需要服务器端必须在响应中，使用 Upgrade 首部指定正在切换那些协议并返回 101 的状态码（切换协议）。如果服务器端不允许切换至客户端期望的通信协议，则需要返回 200 的状态码的响应。尽管切换协议后的第一个动作必须是对初始 HTTP 请求响应，在返回该响应之后，客户端和服务器端的应用层通信完全取决于所选择的新协议。</p><p>Upgrade 首部字段旨在提供一种简单的机制，用于从 HTTP/1.1 切换到其他一些不兼容的协议。Upgrade 首部字段只适用于基于现有传输层连接的协议切换应用层协议。例如具有更高版本的 HTTP 协议，WebSocket 协议等。Upgrade 首部可以指定一项或多项协议名，按优先级排序，并以逗号分隔。</p><p>Upgrade 首部字段仅适用于直接连接。因此升级协议的关键是 Upgrade 首部必须与 Connection 首部一起使用，并且该 Connection 首部的值必须为 Upgrade，这意味着控制代理不再转发 Upgrade 首部。</p><p>这里以从 HTTP/1.1 升级至 WebSocket 为示例来说明请求和响应的变化。</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>GET /chat HTTP/1.1
</span></span><span style=display:flex><span>Host: server.example.com
</span></span><span style=display:flex><span>Upgrade: websocket
</span></span><span style=display:flex><span>Connection: Upgrade
</span></span><span style=display:flex><span>Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
</span></span><span style=display:flex><span>Origin: http://example.com
</span></span><span style=display:flex><span>Sec-WebSocket-Protocol: chat, superchat
</span></span><span style=display:flex><span>Sec-WebSocket-Version: 13
</span></span></code></pre></div><p>图 8.1 协议升级请求示例</p><p>如图 8.1 所示的协议升级请求示例中，Upgrade 首部的值为 websocket，标明客户端期望升级到 WebSocket 协议。并且 Connection 的值为 Upgrade，标明收到该请求的服务器或代理服务器将不再转发 Upgrade 首部。</p><ol><li>如果服务器端允许切换至客户端期望的 WebSocket 协议，则对应的响应示例如图8.2所示。</li></ol><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>HTTP/1.1 101 Switching Protocols
</span></span><span style=display:flex><span>Upgrade: websocket
</span></span><span style=display:flex><span>Connection: Upgrade
</span></span><span style=display:flex><span>Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=
</span></span></code></pre></div><p>图 8.2 允许协议升级的响应示例</p><p>在图8.2 中，响应的状态码为 101，表明服务器端允许客户端切换协议。Upgrade 首部的值为 websocket，表明切换后的协议为 WebSocket 协议。并且 Connection 的值为 Upgrade，表明不再转发 Upgrade 首部。在客户端和服务器端后续的通信中，所使用的通信协议将会是 WebSocket 协议。允许协议升级的示意图如图8.3所示。</p><p><img src=/servlet-book/protocal-upgrades-and-no-blocking-IO/server_allow_to_switch_protocol.png alt=server_allow_to_switch_protocol.png></p><p>图 8.3 允许协议升级的示意图</p><ol start=2><li>如果服务器端不允许切换至客户端期望的 WebSocket 协议，则对应的响应示例如图8.4所示。</li></ol><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>HTTP/1.1 200 ok
</span></span></code></pre></div><p>图 8.4 不允许协议升级的响应示例</p><p>在图8.4 中，响应的状态码为 200，标明服务器端不允许客户端将协议切换值 WebSocket 协议。不允许协议升级的示意图如图8.5所示。</p><p><img src=/servlet-book/protocal-upgrades-and-no-blocking-IO/server_not_allow_to_switch_protocol.png alt=server_not_allow_to_switch_protocol.png></p><p>图 8.5 不允许协议升级的示意图</p><h2 id=82-servlet-对协议升级的支持>8.2 Servlet 对协议升级的支持
<a class=heading-link href=#82-servlet-%e5%af%b9%e5%8d%8f%e8%ae%ae%e5%8d%87%e7%ba%a7%e7%9a%84%e6%94%af%e6%8c%81><i class="fa-solid fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><p>虽然 Servlet 容器提供对 HTTP 协议升级的支持，但是 Servlet 容器本身并不知道升级后的协议。因此 Servlet 规范中提供了 HttpUpgradeHandler 接口，升级后的协议处理封装在 HttpUpgradeHandler 接口中。Servlet 容器和 HttpUpgradeHandler 之间的数据读取或写入是字节流。</p><p>当 Servlet 容器接收到升级协议请求时，如果 Servlet 不允许协议升级，那么在 Servlet 中直接返回 200 的状态码响应即可。如果 Servlet 允许协议升级，那么 Servlet 首先需要在响应中设置 Upgrade 等首部和 101 的状态码。然后 Servlet 还需要调用 HttpServletRequest.upgrade 方法，用来启动协议升级过程。完成上述两项工作之后，处理协议升级的线程依次退出 Servlet 的 service 方法和过滤器，并标记连接由 HttpUpgradeHandler 接口的实现类来处理，同时将允许协议升级的响应结果返回客户端，此时协议升级结束。Servlet 和过滤器只处理初始的 HTTP 请求和响应。他们不参与后续通信。换句话说，一旦请求升级，它们就不会被调用。协议升级结束之后，连接并没有断掉，后续的请求通过升级之后的协议与服务端进行通信。当 Servlet 容器收到基于该连接的后续请求时，便会调用 HttpUpgradeHandler 接口实现类的 init 方法，并传递 WebConnection 以允许协议处理程序访问数据流。HttpUpgradeHandler 接口实现类对象可以通过 WebConnection 对象操作输入流和输出流，以实现与客户端的通信。当然 HttpUpgradeHandler 接口的实现类也可以使用非阻塞 IO 来消费和生成消息。当客户端断开连接之后，容器会调用 HttpUpgradeHandler 接口实现类对象的 destroy 方法，执行资源清理等操作。</p><p>这里以从 HTTP 1.1 升级至 WebSocket 为示例来说明 Servlet 对协议升级的支持。如代码清单 8.1 所示，UpgradeServlet 是一个支持 WebSocket 协议升级的 Servlet 服务。当客户端发送 HTTP 请求到 UpgradeServlet 时，UpgradeServlet 会检查请求中的 Upgrade 首部是否为 websocket，如果是，则调用 HttpServletRequest.upgrade 方法，启动协议升级过程。HttpServletRequest.upgrade 方法的参数是一个实现了 HttpUpgradeHandler 接口的类 WebSocketUpgradeHandler，该方法会实例化一个 WebSocketUpgradeHandler 实例。在 UpgradeServlet 中，我们还设置了响应的状态码为 101，同时设置了 Upgrade、Connection 和 Sec-WebSocket-Accept 等首部，表明服务端支持切换至 WebSocket 协议。如果不是，则返回 200 的状态码响应，表明服务端不支持切换至其他协议。</p><p>代码清单 8.1 支持 WebSocket 进行协议升级的 Servlet 服务：UpgradeServlet.java</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>package</span><span style=color:#6e7681> </span><span style=color:#ff7b72>com.mervyn.book.servlet</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>com.mervyn.book.servlet.utils.SecWebSocketAcceptUtil.generateSecWebSocketAccept</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>com.google.common.net.HttpHeaders</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.servlet.ServletException</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.servlet.annotation.WebServlet</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.servlet.http.HttpServlet</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.servlet.http.HttpServletRequest</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.servlet.http.HttpServletResponse</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>java.io.IOException</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.slf4j.Logger</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#d2a8ff;font-weight:700>@WebServlet</span>(urlPatterns<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;/upgrade&#34;</span>)<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>UpgradeServlet</span><span style=color:#6e7681> </span><span style=color:#ff7b72>extends</span><span style=color:#6e7681> </span>HttpServlet<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span><span style=color:#ff7b72>static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>final</span><span style=color:#6e7681> </span>Logger<span style=color:#6e7681> </span>LOGGER<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>org.slf4j.LoggerFactory.getLogger(UpgradeServlet.class);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#d2a8ff;font-weight:700>@Override</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>protected</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>doGet</span>(HttpServletRequest<span style=color:#6e7681> </span>request,<span style=color:#6e7681> </span>HttpServletResponse<span style=color:#6e7681> </span>response)<span style=color:#6e7681> </span><span style=color:#ff7b72>throws</span><span style=color:#6e7681> </span>ServletException,<span style=color:#6e7681> </span>IOException<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>LOGGER.info(<span style=color:#a5d6ff>&#34;Upgrade request received&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>String<span style=color:#6e7681> </span>upgradeHeader<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>request.getHeader(<span style=color:#a5d6ff>&#34;Upgrade&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>if</span><span style=color:#6e7681> </span>(upgradeHeader<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>!=</span><span style=color:#6e7681> </span><span style=color:#79c0ff>null</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>&amp;&amp;</span><span style=color:#6e7681> </span>upgradeHeader.equals(<span style=color:#a5d6ff>&#34;websocket&#34;</span>))<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>request.upgrade(WebSocketUpgradeHandler.class);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>response.setStatus(HttpServletResponse.SC_SWITCHING_PROTOCOLS);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>response.setHeader(HttpHeaders.CONNECTION,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;Upgrade&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>response.setHeader(HttpHeaders.UPGRADE,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;websocket&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>response.setHeader(HttpHeaders.SEC_WEBSOCKET_ACCEPT,<span style=color:#6e7681> </span>generateSecWebSocketAccept(request.getHeader(HttpHeaders.SEC_WEBSOCKET_KEY)));<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681> </span><span style=color:#ff7b72>else</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>response.setStatus(HttpServletResponse.SC_OK);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>LOGGER.info(<span style=color:#a5d6ff>&#34;Upgrade request ended&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>}<span style=color:#6e7681>
</span></span></span></code></pre></div><p>在代码清单 8.2 中，WebSocketUpgradeHandler 是一个实现了 HttpUpgradeHandler 接口的类，在协议升级之后用来处理来自客户端的 WebSocket 请求，并给予客户端相应的响应。一旦 HTTP 升级过程完成并且升级后的连接准备好开始使用新协议，Servlet 容器就会调用 HttpUpgradeHandler接口的 init 方法。WebSocketUpgradeHandler 在其 init 方法中，我将处理客户端 WebSocket 请求的任务封装成一个
ReadMessageDirectOutputRunnable 任务，并交由业务线程池来处理。当客户端断开连接之后，容器会调用 WebSocketUpgradeHandler 的 destroy 方法，执行资源清理等操作。</p><p>代码清单 8.2 协议升级之后，基于 WebSocket 处理客户端请求和响应的 HttpUpgradeHandler 实现类：WebSocketUpgradeHandler.java</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>package</span><span style=color:#6e7681> </span><span style=color:#ff7b72>com.mervyn.book.servlet</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>com.mervyn.book.servlet.utils.ExecutorServiceConfig</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.servlet.http.HttpUpgradeHandler</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.servlet.http.WebConnection</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.slf4j.Logger</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>WebSocketUpgradeHandler</span><span style=color:#6e7681> </span><span style=color:#ff7b72>implements</span><span style=color:#6e7681> </span>HttpUpgradeHandler<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span><span style=color:#ff7b72>static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>final</span><span style=color:#6e7681> </span>Logger<span style=color:#6e7681> </span>LOGGER<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>org.slf4j.LoggerFactory.getLogger(WebSocketUpgradeHandler.class);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span>WebConnection<span style=color:#6e7681> </span>webConnection;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#d2a8ff;font-weight:700>@Override</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>init</span>(WebConnection<span style=color:#6e7681> </span>webConnection)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>this</span>.webConnection<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>webConnection<span style=color:#6e7681> </span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>ExecutorServiceConfig.getExecutorService()<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.submit(<span style=color:#ff7b72>new</span><span style=color:#6e7681> </span>ReadMessageDirectOutputRunnable(<span style=color:#ff7b72>this</span>.webConnection));<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#d2a8ff;font-weight:700>@Override</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>destroy</span>()<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>try</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#ff7b72>if</span><span style=color:#6e7681> </span>(webConnection<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>!=</span><span style=color:#6e7681> </span><span style=color:#79c0ff>null</span>)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>LOGGER.info(<span style=color:#a5d6ff>&#34;Closing connection&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>webConnection.close();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681> </span><span style=color:#ff7b72>catch</span><span style=color:#6e7681> </span>(Exception<span style=color:#6e7681> </span>e)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>LOGGER.error(<span style=color:#a5d6ff>&#34;Failed to close connection&#34;</span>,<span style=color:#6e7681> </span>e);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>}<span style=color:#6e7681>
</span></span></span></code></pre></div><p>在代码清单 8.3 中，ReadMessageDirectOutputRunnable 是一个实现了 Runnable 接口的类，用来处理与 WebSocket 客户端请求的任务。在该任务中，我们通过 WebConnection 对象获取输入流和输出流，然后通过 WebSocketDataFrameUtil 工具类来读取客户端发送的消息，并将消息写回客户端。如果客户端发送的消息为 WebSocket 关闭帧，则我们通过 WebSocketDataFrameUtil 工具类来发送关闭帧，并关闭连接。</p><p>代码清单 8.3 使用 WebConnection 处理与 WebSocket 客户端请求的任务：ReadMessageDirectOutputRunnable</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>package</span><span style=color:#6e7681> </span><span style=color:#ff7b72>com.mervyn.book.servlet</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>com.mervyn.book.servlet.utils.WebSocketDataFrameUtil.readPayloadFromDataFrame</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>com.mervyn.book.servlet.utils.WebSocketDataFrameUtil.sendCloseViaDataFrame</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>com.mervyn.book.servlet.utils.WebSocketDataFrameUtil.writePayloadToDataFrame</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.servlet.http.WebConnection</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>java.io.IOException</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>java.io.InputStream</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>java.io.OutputStream</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.slf4j.Logger</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>ReadMessageDirectOutputRunnable</span><span style=color:#6e7681> </span><span style=color:#ff7b72>implements</span><span style=color:#6e7681> </span>Runnable<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span><span style=color:#ff7b72>static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>final</span><span style=color:#6e7681> </span>Logger<span style=color:#6e7681> </span>LOGGER<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>org.slf4j.LoggerFactory.getLogger(ReadMessageDirectOutputRunnable.class);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span>WebConnection<span style=color:#6e7681> </span>webConnection;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>ReadMessageDirectOutputRunnable</span>(WebConnection<span style=color:#6e7681> </span>connection)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>this</span>.webConnection<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>connection;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#d2a8ff;font-weight:700>@Override</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>run</span>()<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>try</span><span style=color:#6e7681> </span>(InputStream<span style=color:#6e7681> </span>inputStream<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>webConnection.getInputStream();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>             </span>OutputStream<span style=color:#6e7681> </span>outputStream<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>webConnection.getOutputStream())<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#ff7b72>while</span><span style=color:#6e7681> </span>(<span style=color:#79c0ff>true</span>)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span><span style=color:#ff7b72>try</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                    </span>String<span style=color:#6e7681> </span>payload<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>readPayloadFromDataFrame(inputStream);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                    </span>LOGGER.info(<span style=color:#a5d6ff>&#34;Received message from client: {}&#34;</span>,<span style=color:#6e7681> </span>payload);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                    </span>writePayloadToDataFrame(outputStream,<span style=color:#6e7681> </span>payload,<span style=color:#6e7681> </span><span style=color:#79c0ff>false</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>}<span style=color:#6e7681> </span><span style=color:#ff7b72>catch</span><span style=color:#6e7681> </span>(WebSocketCloseException<span style=color:#6e7681> </span>e)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                    </span>LOGGER.info(<span style=color:#a5d6ff>&#34;WebSocket closing the connection&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                    </span>sendCloseViaDataFrame(outputStream,<span style=color:#6e7681> </span>1000,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;Normal closure&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                    </span><span style=color:#ff7b72>break</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681> </span><span style=color:#ff7b72>catch</span><span style=color:#6e7681> </span>(IOException<span style=color:#6e7681> </span>e)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>LOGGER.info(<span style=color:#a5d6ff>&#34;Failed to read or write WebSocket data&#34;</span>,<span style=color:#6e7681> </span>e);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>}<span style=color:#6e7681>
</span></span></span></code></pre></div><p>我们需要一个 WebSocket 客户端代码验证，UpgradeServlet 中协议升级的功能。如代码清单 8.4 所示，该 WebSocket 客户端首先会连接到 UpgradeServlet，然后发送消息 Hello，5 秒后发送消息 Goodbye，2 秒后关闭连接。</p><p>代码清单 8.4 向 UpgradeServlet 发送请求的 WebSocket 客户端：WebSocketClient</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>package</span><span style=color:#6e7681> </span><span style=color:#ff7b72>com.mervyn.book.servlet</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.websocket.ClientEndpoint</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.websocket.CloseReason</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.websocket.ContainerProvider</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.websocket.OnClose</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.websocket.OnError</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.websocket.OnMessage</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.websocket.OnOpen</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.websocket.Session</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.websocket.WebSocketContainer</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>java.net.URI</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>java.util.concurrent.TimeUnit</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.slf4j.Logger</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#d2a8ff;font-weight:700>@ClientEndpoint</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>WebSocketClient</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span><span style=color:#ff7b72>static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>final</span><span style=color:#6e7681> </span>String<span style=color:#6e7681> </span>SERVER_URI<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;ws://localhost:8080/upgrade&#34;</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span><span style=color:#ff7b72>static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>final</span><span style=color:#6e7681> </span>Logger<span style=color:#6e7681> </span>LOGGER<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>org.slf4j.LoggerFactory.getLogger(WebSocketClient.class);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#d2a8ff;font-weight:700>@OnOpen</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>onOpen</span>(Session<span style=color:#6e7681> </span>session)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>LOGGER.info(<span style=color:#a5d6ff>&#34;Connected to server&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>try</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>session.getBasicRemote().sendText(<span style=color:#a5d6ff>&#34;Hello&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>LOGGER.info(<span style=color:#a5d6ff>&#34;Send message to server&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681> </span><span style=color:#ff7b72>catch</span><span style=color:#6e7681> </span>(Exception<span style=color:#6e7681> </span>e)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>LOGGER.error(<span style=color:#a5d6ff>&#34;Failed to send message to server&#34;</span>,<span style=color:#6e7681> </span>e);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#d2a8ff;font-weight:700>@OnMessage</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>onMessage</span>(String<span style=color:#6e7681> </span>message)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>if</span><span style=color:#6e7681> </span>(LOGGER.isInfoEnabled())<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>LOGGER.info(<span style=color:#a5d6ff>&#34;Received message from server: &#34;</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>+</span><span style=color:#6e7681> </span>message);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#d2a8ff;font-weight:700>@OnClose</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>onClose</span>(Session<span style=color:#6e7681> </span>session,<span style=color:#6e7681> </span>CloseReason<span style=color:#6e7681> </span>closeReason)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>if</span><span style=color:#6e7681> </span>(LOGGER.isInfoEnabled())<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>LOGGER.info(<span style=color:#a5d6ff>&#34;Session closed: &#34;</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>+</span><span style=color:#6e7681> </span>closeReason);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#d2a8ff;font-weight:700>@OnError</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>onError</span>(Session<span style=color:#6e7681> </span>session,<span style=color:#6e7681> </span>Throwable<span style=color:#6e7681> </span>thr)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>if</span><span style=color:#6e7681> </span>(LOGGER.isErrorEnabled())<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>LOGGER.error(<span style=color:#a5d6ff>&#34;Error occurred in session: {}&#34;</span>,<span style=color:#6e7681> </span>session.getId(),<span style=color:#6e7681> </span>thr);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>main</span>(String<span style=color:#ff7b72;font-weight:700>[]</span><span style=color:#6e7681> </span>args)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>WebSocketContainer<span style=color:#6e7681> </span>container<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>ContainerProvider.getWebSocketContainer();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>try</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>URI<span style=color:#6e7681> </span>uri<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#ff7b72>new</span><span style=color:#6e7681> </span>URI(SERVER_URI);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>Session<span style=color:#6e7681> </span>session<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>container.connectToServer(WebSocketClient.class,<span style=color:#6e7681> </span>uri);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>TimeUnit.SECONDS.sleep(5);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>session.getBasicRemote().sendText(<span style=color:#a5d6ff>&#34;Goodbye&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>TimeUnit.SECONDS.sleep(2);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>session.close();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681> </span><span style=color:#ff7b72>catch</span><span style=color:#6e7681> </span>(Exception<span style=color:#6e7681> </span>e)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>LOGGER.error(<span style=color:#a5d6ff>&#34;Failed to connect to server&#34;</span>,<span style=color:#6e7681> </span>e);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>}<span style=color:#6e7681>
</span></span></span></code></pre></div><p>通过代码清单 8.4 所示的 WebSocket 客户端向代码清单 8.1 中的 UpgradeServlet 服务端发送请求。我们可以从服务端看到，图 8.6 所示的服务端日志。从图 8.6 中可以看到，UpgradeServlet 接收到了协议升级的请求，并且成功升级到了 WebSocket 协议。在客户端发送消息 Hello 和 Goodbye 之后，服务端分别接收到了消息 Hello 和 Goodbye，并将消息 Hello 和 Goodbye 分别发送回客户端。最后，服务端关闭了 WebSocket 连接。</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>11:33:45.015 [http-nio-8080-exec-1] INFO com.mervyn.book.servlet.UpgradeServlet -- Upgrade request received
</span></span><span style=display:flex><span>11:33:45.018 [http-nio-8080-exec-1] INFO com.mervyn.book.servlet.UpgradeServlet -- Upgrade request ended
</span></span><span style=display:flex><span>11:33:45.033 [business-thread-0] INFO com.mervyn.book.servlet.ReadMessageDirectOutputRunnable -- Received message from client: Hello
</span></span><span style=display:flex><span>11:33:50.038 [business-thread-0] INFO com.mervyn.book.servlet.ReadMessageDirectOutputRunnable -- Received message from client: Goodbye
</span></span><span style=display:flex><span>11:33:52.045 [business-thread-0] INFO com.mervyn.book.servlet.ReadMessageDirectOutputRunnable -- WebSocket closing the connection
</span></span></code></pre></div><p>图 8.6 Servlet 处理 WebSocket 协议升级服务端示例的日志</p><p>本节仅仅通过简单的示例，演示了 Servlet 如何将 HTTP 1.1 升级至 WebSocket 协议。实际上 HTTP 1.1 升级至 WebSocket 协议的 HttpUpgradeHandler 接口实现类比我们的示例要复杂得多。当然也不需要我们自己开发。Servlet 容器的厂商往往会提供成熟的实现，具体可以参考相关 Servlet 容器的实现。例如，Tomcat 的 WebSocket 协议升级实现类是 <code>org.apache.tomcat.websocket.server.WsHttpUpgradeHandler</code>。对于升级至其他协议，也可以参考相关 Servlet 容器的实现。</p></div><div style="text-align:center;color:#a9a9a9;width:50%;margin:0 auto"><p>本作品采用<a href=http://creativecommons.org/licenses/by-nc-nd/4.0/ style=color:#a9a9a9>知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可</p></div><div style="border-bottom-style:dashed;border-bottom-style:inset;border-bottom-width:2px;width:50%;margin:0 auto"></div><footer><section class=see-also><h3 id=参见-servlet-book>参见 servlet-book
<a class=heading-link href=#%e5%8f%82%e8%a7%81-servlet-book><i class="fa-solid fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h3><nav><ul><li><a href=/posts/servlet-book/quality-assurance-practices-for-software-developers/>软件研发人员的质量保证实践【部分】</a></li></ul></nav></section><div class=comments><script>let getTheme=window.localStorage&&window.localStorage.getItem("colorscheme");getTheme=getTheme??"light";let s=document.createElement("script");s.src="https://giscus.app/client.js",s.setAttribute("data-repo","csmervyn/csmervyn.github.io"),s.setAttribute("data-repo-id","R_kgDOGbYn4A"),s.setAttribute("data-category","Announcements"),s.setAttribute("data-category-id","DIC_kwDOGbYn4M4CWQYR"),s.setAttribute("data-mapping","pathname"),s.setAttribute("data-term",""),s.setAttribute("data-strict","0"),s.setAttribute("data-reactions-enabled","1"),s.setAttribute("data-emit-metadata","0"),s.setAttribute("data-input-position","bottom"),s.setAttribute("data-theme",getTheme),s.setAttribute("data-lang","zh-CN"),s.setAttribute("data-loading",""),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.comments").innerHTML="",document.querySelector("div.comments").appendChild(s)</script></div></footer></article></section></div><footer class=footer><section class=container>©
2019 -
2025
Mervyn
·
技术支持 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>