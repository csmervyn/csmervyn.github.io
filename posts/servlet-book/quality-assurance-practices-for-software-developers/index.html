<!doctype html><html lang=zh-cn><head><title>软件研发人员的质量保证实践【部分】 · 墨客人生</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Mervyn"><meta name=description content="
  11.9.1 进程内集成测试
  
    
    链接到标题
  

进程内集成测试是一种针对应用程序内部组件和模块之间的集成进行测试的方法。它主要关注应用程序内部各个组件之间的协同工作、通信和数据流，以验证它们在应用程序运行时是否能够正确地交互和合作。"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="软件研发人员的质量保证实践【部分】"><meta name=twitter:description content="11.9.1 进程内集成测试 链接到标题 进程内集成测试是一种针对应用程序内部组件和模块之间的集成进行测试的方法。它主要关注应用程序内部各个组件之间的协同工作、通信和数据流，以验证它们在应用程序运行时是否能够正确地交互和合作。"><meta property="og:url" content="http://example.org/posts/servlet-book/quality-assurance-practices-for-software-developers/"><meta property="og:site_name" content="墨客人生"><meta property="og:title" content="软件研发人员的质量保证实践【部分】"><meta property="og:description" content="11.9.1 进程内集成测试 链接到标题 进程内集成测试是一种针对应用程序内部组件和模块之间的集成进行测试的方法。它主要关注应用程序内部各个组件之间的协同工作、通信和数据流，以验证它们在应用程序运行时是否能够正确地交互和合作。"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-02-09T21:48:32+07:00"><meta property="article:modified_time" content="2025-02-09T21:48:32+07:00"><meta property="article:tag" content="进程内集成测试"><meta property="article:tag" content="MockWebServer"><meta property="article:tag" content="Testcontainers"><link rel=canonical href=http://example.org/posts/servlet-book/quality-assurance-practices-for-software-developers/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.60f552a2c0452fcc0254c54f21c3e0728460c1ae85f97a9c35833a222ef8b884.css integrity="sha256-YPVSosBFL8wCVMVPIcPgcoRgwa6F+XqcNYM6Ii74uIQ=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/img/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/img/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=http://example.org/>墨客人生
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/life/>生活</a></li><li class=navigation-item><a class=navigation-link href=/posts/>博客</a></li><li class=navigation-item><a class=navigation-link href=/about-me>关于我</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=http://example.org/posts/servlet-book/quality-assurance-practices-for-software-developers/>软件研发人员的质量保证实践【部分】</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2025-02-09T21:48:32+07:00>February 9, 2025
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
阅读时间：5 分钟
</span><span class=post-word-count>| 🍉 2458 字</span></div><div class=authors><i class="fa-solid fa-user" aria-hidden=true></i>
<a href=/authors/mervyn/>Mervyn</a></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/%E8%BF%9B%E7%A8%8B%E5%86%85%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95/>进程内集成测试</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/mockwebserver/>MockWebServer</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/testcontainers/>Testcontainers</a></span></div></div></header><div class=post-content><h3 id=1191-进程内集成测试>11.9.1 进程内集成测试
<a class=heading-link href=#1191-%e8%bf%9b%e7%a8%8b%e5%86%85%e9%9b%86%e6%88%90%e6%b5%8b%e8%af%95><i class="fa-solid fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h3><p>进程内集成测试是一种针对应用程序内部组件和模块之间的集成进行测试的方法。它主要关注应用程序内部各个组件之间的协同工作、通信和数据流，以验证它们在应用程序运行时是否能够正确地交互和合作。</p><p>在进程内集成测试中，应用程序的不同模块或组件被加载到同一个进程中，并在这个共享环境中进行测试。这种测试方法更接近实际运行环境，可以更准确地模拟应用程序的行为和性能。以微服务架构下的 Servlet Web 应用为例，其进程内架构可能包含多个组件，如 Servlet、Service、Repository、MQClient、RestClient等组件，如图 11-14 所示。进程内集成测试的目的是验证进程内这些组件作为一个整体，工作是否符合预期。然而我们的 Servlet Web 应用可能有多个下游依赖项，如图 11-14 的 Microservice A，其依赖下游包括数据库和 Microservice B 以及消息中间件。因此如果需要对图 11-14 中的 Microservice A 进行进程内集成测试，我们则需要在测试之前，知道如何 mock 这些下游依赖项。</p><p><img src=/servlet-book/Quality-assurance-practices-for-software-developers/service-before-we-test.svg alt="Servlet Web 应用进程内架构"></p><p>图11-14 Servlet Web 应用进程内架构</p><p>我们来直接回答上面的问题。如果需要对图 11-14 所示的 Microservice A 应用进行进程内集成测试，我们可以通过 MockWebServer 或 WireMock 来 mock 被依赖的 Microservice B；通过 Testcontainers 来 mock 数据库和消息中间件，如图 11-15所示。</p><p><img src=/servlet-book/Quality-assurance-practices-for-software-developers/integration-test-with-mock.svg alt="进程内集成测试 Mock 下游依赖项"></p><p>图11-15 进程内集成测试 Mock 下游依赖项</p><p>下面我们将通过具体的示例来说明，如何使用 MockWebServer 和 Testcontainers 来 mock 依赖项。</p><h4 id=mock-外部的-api>Mock 外部的 API
<a class=heading-link href=#mock-%e5%a4%96%e9%83%a8%e7%9a%84-api><i class="fa-solid fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h4><p>Mock 外部的 API 可以使用 MockWebServer 和 WireMock 以及 MockServer 等 API 模拟测试工具。下面以 MockWebServer 为例，展示其用法。MockWebServer 是一个用于测试 HTTP 客户端的可编程 Web 服务器。该库旨在简化测试，确保你的应用在进行 HTTP 和 HTTPS 调用时“行为正确”。它允许你指定返回的响应，并验证是否按预期发出了请求。</p><p>假设我们的应用是一个根据天气的情况给用户推荐穿衣的提醒的微服务。我们的 ClothingRemmendation 微服务通过 Weather 微服务的 <code>/weather/{cityId}</code> GET 接口，获取天气数据。并根据天气数据生成穿衣建议。如果对 ClothingRemmendation 微服务进行进程内集成测试，可以通过 MockWebServer 来 mock Weather 微服务的 <code>/weather/{cityId}</code> GET 接口。其使用真实依赖与使用 MockWebServer mock 依赖的进程内架构对比图如图 11-16 所示。</p><p><img src=/servlet-book/Quality-assurance-practices-for-software-developers/mock-external-microservice-via-MockWebServer.svg alt="使用真实依赖与使用 MockWebServer mock 依赖的进程内架构对比图"></p><p>图11-16 使用真实依赖与使用 MockWebServer mock 依赖的进程内架构对比图</p><p>基于图 11-16 所述场景，我们来看一下如何使用 MockWebServer mock Weather 微服务的 <code>/weather/{cityId}</code> GET 接口，并对 ClothingRemmendation 微服务的推荐穿衣接口进行进程内集成测试。</p><ol><li><p>首先通过 Maven 或 Gradle 等构建工具引入 MockWebServer 的依赖。以 Maven 为例，其 MockWebServer 的依赖如代码清单 11-39 所示。</p><p>代码清单 11-39 引入 MockWebServer 依赖 pom.xml</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span> <span style=color:#7ee787>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>     <span style=color:#7ee787>&lt;groupId&gt;</span>com.squareup.okhttp3<span style=color:#7ee787>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>     <span style=color:#7ee787>&lt;artifactId&gt;</span>mockwebserver<span style=color:#7ee787>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>     <span style=color:#7ee787>&lt;version&gt;</span>4.11.0<span style=color:#7ee787>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>     <span style=color:#7ee787>&lt;scope&gt;</span>test<span style=color:#7ee787>&lt;/scope&gt;</span>
</span></span><span style=display:flex><span> <span style=color:#7ee787>&lt;/dependency&gt;</span>
</span></span></code></pre></div></li><li><p>首先构造 MockWebServer 对象。并为指定的 <code>/weather/{cityId}</code> GET 接口 mock 其响应。默认情况下 MockWebServer 使用队列来指定一系列响应，我们可以使用 server.enqueue() 方法来模拟响应。当然也可以使用 Dispatcher 根据请求路径的不同 mock 不同的响应。然后启动 MockWebServer。其过程如代码清单 11-40 的 setup 方法所示。</p></li><li><p>编写一个进程内集成测试，并向 MockWebServer 发起请求，验证进程内的组件 ClothingRecommendationServlet、ClothingRecommendationService、WeatherRestClient 的整体逻辑和这些组件是否向 MockWebServer 发出了预期的请求。其过程如代码清单 11-40 的 shouldReturnColdAndRainClothingRecommendationWhenTemperatureIsLessThan10AndRain 方法所示。</p></li><li><p>关闭 MockWebServer，其过程如代码清单 11-40 的 tearDown 方法所示。</p></li></ol><p>代码清单 11-40 使用 MockWebServer mock 获取天气接口，并对穿衣推荐接口进行进程内集成测试 ClothingRecommendationIntegrationTest.java</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>package</span><span style=color:#6e7681> </span><span style=color:#ff7b72>com.mervyn.book.servlet</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.servlet.ServletContext</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>okhttp3.mockwebserver.Dispatcher</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>okhttp3.mockwebserver.MockResponse</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>okhttp3.mockwebserver.MockWebServer</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>okhttp3.mockwebserver.RecordedRequest</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.apache.catalina.Context</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.apache.catalina.startup.Tomcat</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.hamcrest.core.Is</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.junit.jupiter.api.AfterEach</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.junit.jupiter.api.BeforeEach</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.junit.jupiter.api.Test</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.junit.jupiter.api.extension.ExtendWith</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>java.io.IOException</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>io.restassured.RestAssured.when</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#d2a8ff;font-weight:700>@ExtendWith</span>({WebServerExtension.class})<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>SayHelloServletIntegrationTest</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>   </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span><span style=color:#ff7b72>static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>final</span><span style=color:#6e7681> </span><span style=color:#ff7b72>int</span><span style=color:#6e7681> </span>PORT<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>8080;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>   </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span><span style=color:#ff7b72>static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>final</span><span style=color:#6e7681> </span>String<span style=color:#6e7681> </span>RECOMMENDATION_MAPPING<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;/recommendation&#34;</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>   </span><span style=color:#ff7b72>private</span><span style=color:#6e7681>  </span>MockWebServer<span style=color:#6e7681> </span>mockWebServer;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>   </span><span style=color:#d2a8ff;font-weight:700>@BeforeEach</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>   </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>setup</span>()<span style=color:#6e7681> </span><span style=color:#ff7b72>throws</span><span style=color:#6e7681> </span>IOException<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>mockWebServer<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#ff7b72>new</span><span style=color:#6e7681> </span>MockWebServer();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>mockResponseForGetWeatherEndpoint();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>mockWebServer.start(8012);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>setWeatherServiceBaseUrl(mockWebServer.url(<span style=color:#a5d6ff>&#34;/&#34;</span>).toString());<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>   </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>   </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>mockResponseForGetWeatherEndpoint</span>()<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#ff7b72>final</span><span style=color:#6e7681> </span>Dispatcher<span style=color:#6e7681> </span>dispatcher<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#ff7b72>new</span><span style=color:#6e7681> </span>Dispatcher()<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>         </span><span style=color:#d2a8ff;font-weight:700>@Override</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>         </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span>MockResponse<span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>dispatch</span>(RecordedRequest<span style=color:#6e7681> </span>request)<span style=color:#6e7681> </span><span style=color:#ff7b72>throws</span><span style=color:#6e7681> </span>InterruptedException<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#ff7b72>switch</span><span style=color:#6e7681> </span>(request.getPath())<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>               </span><span style=color:#ff7b72>case</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;/weather/657&#34;</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                  </span><span style=color:#ff7b72>return</span><span style=color:#6e7681> </span><span style=color:#ff7b72>new</span><span style=color:#6e7681> </span>MockResponse().setResponseCode(200).setBody(<span style=color:#a5d6ff>&#34;{\n&#34;</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>+</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                          </span><span style=color:#a5d6ff>&#34;  \&#34;id\&#34;: 657,\n&#34;</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>+</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                          </span><span style=color:#a5d6ff>&#34;  \&#34;city\&#34;: \&#34;Xi&#39;An\&#34;,\n&#34;</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>+</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                          </span><span style=color:#a5d6ff>&#34;  \&#34;temperature\&#34;: 8,\n&#34;</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>+</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                          </span><span style=color:#a5d6ff>&#34;  \&#34;description\&#34;: \&#34;rain\&#34;\n&#34;</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>+</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                          </span><span style=color:#a5d6ff>&#34;}&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#ff7b72>return</span><span style=color:#6e7681> </span><span style=color:#ff7b72>new</span><span style=color:#6e7681> </span>MockResponse().setResponseCode(404);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>         </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>};<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>mockWebServer.setDispatcher(dispatcher);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>   </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>   </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>setWeatherServiceBaseUrl</span>(String<span style=color:#6e7681> </span>url)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>Tomcat<span style=color:#6e7681> </span>tomcat<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>Server.getTomcat();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>Context<span style=color:#6e7681> </span>rootContext<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>(Context)<span style=color:#6e7681> </span>tomcat.getHost().findChild(<span style=color:#a5d6ff>&#34;&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>ServletContext<span style=color:#6e7681> </span>servletContext<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>rootContext.getServletContext();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>servletContext.setAttribute(<span style=color:#a5d6ff>&#34;weatherServiceBaseUrl&#34;</span>,<span style=color:#6e7681> </span>url);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>   </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>   </span><span style=color:#d2a8ff;font-weight:700>@Test</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>   </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>shouldReturnColdAndRainClothingRecommendationWhenTemperatureIsLessThan10AndRain</span>()<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>String<span style=color:#6e7681> </span>url<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;http://localhost:&#34;</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>+</span><span style=color:#6e7681> </span>PORT<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>+</span><span style=color:#6e7681> </span>RECOMMENDATION_MAPPING<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>+</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;?cityId=657&#34;</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>when().get(url)<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span>.then()<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span>.statusCode(200)<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span>.body(Is.is(<span style=color:#a5d6ff>&#34;天气较冷，建议穿毛衣、外套或风衣，必要时带上帽子。此外，天气有雨，请携带雨伞或穿防水鞋。&#34;</span>));<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>   </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>   </span><span style=color:#d2a8ff;font-weight:700>@AfterEach</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>   </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>tearDown</span>()<span style=color:#6e7681> </span><span style=color:#ff7b72>throws</span><span style=color:#6e7681> </span>IOException<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>mockWebServer.shutdown();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>   </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>}<span style=color:#6e7681>
</span></span></span></code></pre></div><h3 id=mock-外部的数据库消息队列等>Mock 外部的数据库/消息队列等
<a class=heading-link href=#mock-%e5%a4%96%e9%83%a8%e7%9a%84%e6%95%b0%e6%8d%ae%e5%ba%93%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e7%ad%89><i class="fa-solid fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h3><p>我们可以使用 Testcontainers 模拟外部的数据库/消息队列等下游依赖。下面使用 Testcontainers 来 Mock PostgreSQL 为例，来说明其用法。Testcontainers 是一个开源库，用于提供一次性、轻量级的数据库、消息代理、网页浏览器实例，或者几乎任何可以运行在 Docker 容器中的东西。另外 Testcontainers 提供了超过 50 种模块，这些模块是各种依赖项的预配置实现，可以让我们编写测试变得更加方便。</p><p>现在假设我们的应用对外提供了一个接口，用来展示用户的列表。该接口依赖从 PostgreSQL 的 account 库中的 users 表中查出所有用户的数据。如果需要对该接口进行进程内集成测试，我们可以使用 Testcontainers 来 mock 一个 PostgreSQL 类型的 account 库，并在该库中的 users 表 mock 一些预定义的数据。其使用真实依赖与使用 Testcontainers mock 依赖的进程内架构对比图如图 11-17 所示。</p><p><img src=/servlet-book/Quality-assurance-practices-for-software-developers/mock-PostgreSQL-via-testcontainers.svg alt="使用真实依赖与使用 Testcontainers mock 依赖的进程内架构对比图"></p><p>图11-17 使用真实依赖与使用 Testcontainers mock 依赖的进程内架构对比图</p><p>基于图 11-17 所述的场景，我们来看一下如何使用 Testcontainers mock 一个 PostgreSQL 类型的 account 库，并在该库中的 users 表 mock 一些用于测试的预定义的数据。然后对 Account 微服务的用户列表接口进行进程内集成测试。</p><ol><li><p>首先需要通过 Maven 或 Gradle 等构建工具引入 Testcontainers 的依赖和被 Mock 的 PostgreSQL 依赖。以 Maven 为例，其 Testcontainers 相关的依赖如代码清单 11-41 所示。</p><p>代码清单 11-41 引入 Testcontainers 以及 postgresql 和 junit-jupiter 模块的依赖 pom.xml</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#7ee787>&lt;dependencies&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;groupId&gt;</span>org.testcontainers<span style=color:#7ee787>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;artifactId&gt;</span>testcontainers<span style=color:#7ee787>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;scope&gt;</span>test<span style=color:#7ee787>&lt;/scope&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;groupId&gt;</span>org.testcontainers<span style=color:#7ee787>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;artifactId&gt;</span>postgresql<span style=color:#7ee787>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;scope&gt;</span>test<span style=color:#7ee787>&lt;/scope&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;groupId&gt;</span>org.testcontainers<span style=color:#7ee787>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;artifactId&gt;</span>junit-jupiter<span style=color:#7ee787>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;scope&gt;</span>test<span style=color:#7ee787>&lt;/scope&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#7ee787>&lt;/dependencies&gt;</span>
</span></span></code></pre></div><p>其中 artifactId 为 testcontainers 的依赖是用于管理隔离容器 Testcontainers 的核心依赖；artifactId 为 postgresql 的依赖是引入 Testcontainers 的 Postgres 模块；artifactId 为 junit-jupiter 的依赖是提供了基于 JUnit Jupiter 扩展模型的 API 的模块，该模块可以控制测试容器的作用域（每个测试方法都会重启的容器或在测试类的所有方法之间共享的容器）。</p></li><li><p>配置 mock PostgreSQL 的 PostgreSQLContainer。如代码清单 11-42 中的 @Container 所在行所示，该注解配合 @Testcontainers 注解在测试测试之前启动 docker 容器，在测试结束之后自动销毁容器。</p></li><li><p>在 mock 的数据库中构造测试依赖的数据，执行测试和验证是否满足期望。如代码清单 11-42 中的 shouldReturnThreeUserWhenGetAllUsers 方法所示。</p></li></ol><p>代码清单 11-42 使用 Testcontainers mock 一个 PostgreSQL 数据库，并对如进行进程内集成测试 UserServletIntegrationTest.java</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff7b72>package</span><span style=color:#6e7681> </span><span style=color:#ff7b72>com.mervyn.book.servlet</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>jakarta.servlet.ServletContext</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.apache.catalina.Context</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.apache.catalina.startup.Tomcat</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.junit.jupiter.api.Test</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.junit.jupiter.api.extension.ExtendWith</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.testcontainers.containers.PostgreSQLContainer</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.testcontainers.junit.jupiter.Container</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.testcontainers.junit.jupiter.Testcontainers</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>java.sql.Connection</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>java.sql.DriverManager</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>java.sql.SQLException</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>java.util.Objects</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>io.restassured.RestAssured.when</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>import static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>org.hamcrest.core.Is.is</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#d2a8ff;font-weight:700>@ExtendWith</span>({WebServerExtension.class})<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#d2a8ff;font-weight:700>@Testcontainers</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>UserServletIntegrationTest</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>   </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span><span style=color:#ff7b72>static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>final</span><span style=color:#6e7681> </span><span style=color:#ff7b72>int</span><span style=color:#6e7681> </span>PORT<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>8080;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>   </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span><span style=color:#ff7b72>static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>final</span><span style=color:#6e7681> </span>String<span style=color:#6e7681> </span>USERS_MAPPING<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;/users&#34;</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>   </span><span style=color:#d2a8ff;font-weight:700>@Container</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>   </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span><span style=color:#ff7b72>static</span><span style=color:#6e7681> </span>PostgreSQLContainer<span style=color:#ff7b72;font-weight:700>&lt;?&gt;</span><span style=color:#6e7681> </span>postgresContainer<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#ff7b72>new</span><span style=color:#6e7681> </span>PostgreSQLContainer<span style=color:#ff7b72;font-weight:700>&lt;&gt;</span>(<span style=color:#a5d6ff>&#34;postgres:16-alpine&#34;</span>)<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>           </span>.withDatabaseName(<span style=color:#a5d6ff>&#34;account&#34;</span>)<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>           </span>.withUsername(<span style=color:#a5d6ff>&#34;root&#34;</span>)<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>           </span>.withPassword(<span style=color:#a5d6ff>&#34;change-it&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>   </span><span style=color:#d2a8ff;font-weight:700>@Test</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>   </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>shouldReturnThreeUserWhenGetAllUsers</span>()<span style=color:#6e7681> </span><span style=color:#ff7b72>throws</span><span style=color:#6e7681> </span>SQLException<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>insertMockUserDataToDB();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>setupDatabaseConnectionInformation();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>String<span style=color:#6e7681> </span>url<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;http://localhost:&#34;</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>+</span><span style=color:#6e7681> </span>PORT<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>+</span><span style=color:#6e7681> </span>USERS_MAPPING;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>when().get(url)<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span>.then()<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span>.statusCode(200)<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span>.body(<span style=color:#a5d6ff>&#34;size()&#34;</span>,<span style=color:#6e7681> </span>is(3))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span>.body(<span style=color:#a5d6ff>&#34;[0].name&#34;</span>,<span style=color:#6e7681> </span>is(<span style=color:#a5d6ff>&#34;Alice&#34;</span>))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span>.body(<span style=color:#a5d6ff>&#34;[1].name&#34;</span>,<span style=color:#6e7681> </span>is(<span style=color:#a5d6ff>&#34;Bob&#34;</span>))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span>.body(<span style=color:#a5d6ff>&#34;[2].name&#34;</span>,<span style=color:#6e7681> </span>is(<span style=color:#a5d6ff>&#34;Charlie&#34;</span>));<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>   </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>   </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>insertMockUserDataToDB</span>()<span style=color:#6e7681> </span><span style=color:#ff7b72>throws</span><span style=color:#6e7681> </span>SQLException<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>Connection<span style=color:#6e7681> </span>connection<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>DriverManager.getConnection(<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span>postgresContainer.getJdbcUrl(),<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span>postgresContainer.getUsername(),<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>              </span>postgresContainer.getPassword()<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>connection.createStatement().execute(<span style=color:#a5d6ff>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  CREATE TABLE users (
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                      id SERIAL PRIMARY KEY,
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                      name VARCHAR(50)
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  );
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                  INSERT INTO users (name) VALUES (&#39;Alice&#39;), (&#39;Bob&#39;), (&#39;Charlie&#39;);
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>              &#34;&#34;&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#ff7b72>if</span><span style=color:#6e7681> </span>(Objects.nonNull(connection))<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>         </span>connection.close();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>   </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>   </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>setupDatabaseConnectionInformation</span>()<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>Tomcat<span style=color:#6e7681> </span>tomcat<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>Server.getTomcat();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>Context<span style=color:#6e7681> </span>rootContext<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>(Context)<span style=color:#6e7681> </span>tomcat.getHost().findChild(<span style=color:#a5d6ff>&#34;&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>ServletContext<span style=color:#6e7681> </span>servletContext<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>rootContext.getServletContext();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>servletContext.setAttribute(<span style=color:#a5d6ff>&#34;jdbcUrl&#34;</span>,<span style=color:#6e7681> </span>postgresContainer.getJdbcUrl());<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>servletContext.setAttribute(<span style=color:#a5d6ff>&#34;username&#34;</span>,<span style=color:#6e7681> </span>postgresContainer.getUsername());<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>servletContext.setAttribute(<span style=color:#a5d6ff>&#34;password&#34;</span>,<span style=color:#6e7681> </span>postgresContainer.getPassword());<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>   </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>}<span style=color:#6e7681>
</span></span></span></code></pre></div></div><div style="text-align:center;color:#a9a9a9;width:50%;margin:0 auto"><p>本作品采用<a href=http://creativecommons.org/licenses/by-nc-nd/4.0/ style=color:#a9a9a9>知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可</p></div><div style="border-bottom-style:dashed;border-bottom-style:inset;border-bottom-width:2px;width:50%;margin:0 auto"></div><footer><div class=comments><script>let getTheme=window.localStorage&&window.localStorage.getItem("colorscheme");getTheme=getTheme??"light";let s=document.createElement("script");s.src="https://giscus.app/client.js",s.setAttribute("data-repo","csmervyn/csmervyn.github.io"),s.setAttribute("data-repo-id","R_kgDOGbYn4A"),s.setAttribute("data-category","Announcements"),s.setAttribute("data-category-id","DIC_kwDOGbYn4M4CWQYR"),s.setAttribute("data-mapping","pathname"),s.setAttribute("data-term",""),s.setAttribute("data-strict","0"),s.setAttribute("data-reactions-enabled","1"),s.setAttribute("data-emit-metadata","0"),s.setAttribute("data-input-position","bottom"),s.setAttribute("data-theme",getTheme),s.setAttribute("data-lang","zh-CN"),s.setAttribute("data-loading",""),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.comments").innerHTML="",document.querySelector("div.comments").appendChild(s)</script></div></footer></article></section></div><footer class=footer><section class=container>©
2019 -
2025
Mervyn
·
技术支持 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>